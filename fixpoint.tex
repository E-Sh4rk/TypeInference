\documentclass[a4paper]{article}

\usepackage{setup}

\hypersetup{pdfstartview=XYZ}%         zoom par defaut

\setlength{\droptitle}{-5em}   % This is your set screw
\title{\vspace{1.5cm}Type inference - M2 Internship}
\author{Mickael LAURENT}
\date{\vspace{-5ex}}

\pagenumbering{gobble}

\theoremstyle{definition}
\newtheorem{theorem}{Theorem}
\newtheorem{lemma}{Lemma}
\newtheorem{definition}{Definition}
\newtheorem{property}{Property}
\newtheorem{corollary}{Corollary}

\begin{document}

    \maketitle

    \section{Typing system}

    \[
      \begin{array}{lrcl}
      \textbf{Types} & t & ::= & b\alt \arrow t t\alt \pair t t\alt t\vee t \alt \neg t \alt \Empty\\
      \textbf{Atoms} & t_A & ::= & b\alt \arrow t t\alt \pair t t\\
      \textbf{Non-Functional Types} & t_b & ::= & b \alt \pair {t_b} {t_b} \alt t_b\vee t_b \alt \neg t_b \alt \Empty\\
      \textbf{Normal Types} & \hat t & ::= & t_b \alt \arrow {\hat t} {\hat t}\alt \hat t \wedge \hat t \alt \hat t\vee \hat t
      \end{array}
    \]

    \[
      \norm t = \text{remove negative arrows from DNF}
    \]

    \[
    \begin{array}{lcl}
      \typep+\epsilon{\Gamma,e,t} & = & t\\
      \typep-\epsilon{\Gamma,e,t} & = & \neg t\\
      \typep{p}{\varpi.0}{\Gamma,e,t} & = & \neg(\arrow{\Gp p{\Gamma,e,t}{(\varpi.1)}}{\neg \Gp p {\Gamma,e,t} (\varpi)})\\
      \typep{p}{\varpi.1}{\Gamma,e,t} & = & \worra{\tyof{\occ e{\varpi.0}}\Gamma}{\Gp p {\Gamma,e,t} (\varpi)}\\
      \typep{p}{\varpi.l}{\Gamma,e,t} & = & \bpl{\Gp p {\Gamma,e,t} (\varpi)}\\
      \typep{p}{\varpi.r}{\Gamma,e,t} & = & \bpr{\Gp p {\Gamma,e,t} (\varpi)}\\
      \typep{p}{\varpi.f}{\Gamma,e,t} & = & \pair{\Gp p {\Gamma,e,t} (\varpi)}\Any\\
      \typep{p}{\varpi.s}{\Gamma,e,t} & = & \pair\Any{\Gp p {\Gamma,e,t} (\varpi)}\\ \\
      \Gp p {\Gamma,e,t} (\varpi) & = & \norm {\typep p \varpi {\Gamma,e,t} \land \tyof {\occ e \varpi} \Gamma
      \land \tyof {\occ e \varpi} {\Gamma\setminus\{e\}}}\\
    \end{array}
    \]

    \begin{align*}
      &(\Refine p {(e,t)} \Gamma)(e') = 
        \left\{\begin{array}{ll}
          \bigwedge_{\{\varpi \alt \occ e \varpi \equiv e'\}} \Gp p {\Gamma,e,t} (\varpi) & \text{if } \exists \varpi.\ \occ e \varpi \equiv e' \\
          \Gamma(e') & \text{otherwise, if } e' \in \dom \Gamma\\
          \text{undefined} & \text{otherwise}
        \end{array}\right.\\&\\
      &\Gaux p {\varnothing} \Gamma = \Gamma\\
      &\Gaux p {\cons {(e,t)} {\vec i}} \Gamma = \Gaux p {\vec i} {\Refine p {(e,t)} \Gamma}\\&\\
      &\Genv p {\vec {i}} \Gamma=\fixpoint_\Gamma (\Gaa p {\vec {i}})
    \end{align*}

    \begin{mathpar}

        \Infer[Occ]
            {
            }
            { \Gamma \vdash e: \Gamma(e) }
            { e\in\dom\Gamma}
        \qquad
        \Infer[Const]
            { }
            {\Gamma\vdash c:\basic{c}}
            {c\not\in\dom\Gamma}
         \\
        \Infer[Abs]
            {\Gamma,x:s_i\vdash e:t_i'\\t_i'\leq t_i}
            {
            \Gamma\vdash\lambda^{\wedge_{i\in I}\arrow {s_i} {t_i}}x.e:\textstyle\bigwedge_{i\in I}\arrow {s_i} {t_i}
            }
            {\lambda^{\wedge_{i\in I}\arrow {s_i} {t_i}}x.e\not\in\dom\Gamma}
            \\
        \Infer[App]
            {
              \Gamma \vdash e_1: t_1 \\
              \Gamma\vdash e_2: t_2\\
              t_1 \leq \arrow \Empty \Any\\
              t_2 \leq \dom {t_1}
            }
            { \Gamma \vdash {e_1}{e_2}: t_1 \circ t_2 }
            { {e_1}{e_2}\not\in\dom\Gamma}
            \\
        \Infer[If]
              {\Gamma\vdash e:t_0\\
                \left\{
                  \makebox{$\begin{array}{ll} %\Gamma,
                  \Genv + {e,t} \Gamma \vdash e_1 : t_1 & \text{ if } t_0 \not\leq \neg t\\
                  t_1 = \Empty & \text{ otherwise}
                \end{array}$}\right.\\
                \left\{
                  \makebox{$\begin{array}{ll} %\Gamma,
                  \Genv - {e,t} \Gamma \vdash e_2 : t_2 & \text{ if } t_0 \not\leq t\\
                  t_2 = \Empty & \text{ otherwise}
                \end{array}$}\right.}
              {\Gamma\vdash \ite {e} t {e_1}{e_2}: t_1\vee t_2}
              %{\ite {e} t {e_1}{e_2}\not\in\dom\Gamma}
              {\texttt{if}\dots\not\in\dom\Gamma}
        \\
        \Infer[Proj]
        {\Gamma \vdash e:t\and t\leq\pair\Any\Any}
        {\Gamma \vdash \pi_i e:\bpi_{\mathbf{i}}(t)}
        {\pi_i e\not\in\dom\Gamma}

        \Infer[Pair]
        {\Gamma \vdash e_1:t_1 \and \Gamma \vdash e_2:t_2}
        {\Gamma \vdash (e_1,e_2):\pair{t_1}{t_2}}
        {(e_1,e_2)\not\in\dom\Gamma}
    \end{mathpar}

    \section{Proofs}

    \begin{definition}[DNF]
      A disjonctive normal form $\tau$ is a finite set of pairs of finite sets atoms such that:
      \[ \forall (P,N)\in \tau.\ \semantic {\bigwedge_{t_A \in P} t_A \land \bigwedge_{t_A \in N} \neg t_A} \neq \varnothing \]

      The interpretation $\semantic \tau$ of $\tau$ is the following:
      \[
        \semantic \tau = \semantic {\bigvee_{(P,N)\in \tau} \left(\bigwedge_{t_A \in P} t_A \land \bigwedge_{t_A \in N} \neg t_A \right)}
      \]
    \end{definition}

    \begin{property}
      For every type $t$, we can compute a DNF $\tau$ such that $\semantic t = \semantic \tau$.
    \end{property}

    \begin{definition}[Plinth]
      A plinth $S$ is a set of types such that:
      \begin{itemize}
        \item $S$ is finite.
        \item $\Empty \in S$ and $S$ is stable by $\neg, \land, \vee$. 
        \item If $\tau$ is a DNF of $t\in S$, let's introduce $A=\{t_a \alt \exists (P,N) \in \tau \text{ s.t. } t_a \in P \text{ or } t_a \in N \}$. Thus:
        \begin{itemize}
          \item For all $t_a \in A$, we have $t_a \in S$.
          \item For all $t_1$, $t_2$ such that $\arrow {t_1} {t_2} \in A$ or $\pair {t_1} {t_2} \in A$,
          we have $t_1 \in S$ and $t_2 \in S$.
        \end{itemize}
      \end{itemize}
    \end{definition}

    \begin{theorem}
      Every finite set of types is included in a plinth.
    \end{theorem}

    Proof: Alain Frisch thesis, theorem 3.8 (p64).

    \subsection{Computation of the least fixpoint}

    Let $\vec i$, $p$ and $\Gamma$ (well-formed).

    The existence of a least fixpoint $\fixpoint_\Gamma (\Gaa p {\vec {i}})$ is trivial since $\Gaa p {\vec {i}}$ is extensive
    (for the order relation $\leq$ on environments).

    Let's prove that we can reach it in a finite number of iterations.\\
    In this proof, we will suppose that there is no occurence of a $\texttt{if}$ expression in any of the tested expressions
    (but there can be a $\texttt{if}$ subexpression if it is inside a lambda).

    We will show that, starting from $\Gamma$, the successive $\Gaa p {\vec {i}}$ stay in a finite set of environments.

    Let's consider a finite set of types $T$ such that:
    \begin{itemize}
      \item $\forall (e,t) \in \vec i$, $t \in T$
      \item $\forall (e,t) \in \vec i\ \forall \varpi$, if $\occ e \varpi$ is a lambda abstraction $\lambda^tx.e_x$, then $t \in T$
      \item $\forall (e,t) \in \vec i\ \forall \varpi$, if $\occ e \varpi \in \dom \Gamma$, then $\Gamma(\occ e \varpi) \in T$
    \end{itemize}

    Using the previous theorem, let $S$ by a plinth such that $T \subseteq S$. In particular we know that $S$ is finite.

    We define the "product context" of a type $t$ by:
    \[
      \texttt{pctx}(t)=\left\{
        \begin{array}{ll}
          \pair {\texttt{pctx}(\bpl t)} {\texttt{pctx}(\bpr t)} & \text{ if } t \leq \pair \Any \Any\\
          {[}] & \text{ otherwise}
        \end{array}  
      \right.
    \]

    Let's prove the following invariant. After any number of iteration, the resulting environment $\Gamma'$ is such that:\\
    $\forall (e,t) \in \vec i\ \forall \varpi$, if $\occ e \varpi \in \dom {\Gamma'}$, then there exists $\vec s$ a vector of elements of $S$ s.t. $\Gamma'(\occ e \varpi) = \texttt{pctx}(\tyof {\occ e \varpi} \Gamma)[\vec s]$.
    
    We prove it by induction on the number of iterations.

    The base case (0 iteration) is trivial.

    For the inductive case, let's take $\Gamma'$ (well-formed) that satifies the induction hypothesis
    and show that $\Gamma'' = \Gaux p {\vec {i}} {\Gamma'}$ also satisfies the induction hypothesis.

    Let's fix $(e,t)$ and $\varpi$.\\
    We need to show that there exists $\vec s$ a vector of elements of $S$ such that $\Gp p {\Gamma'',e,t} (\varpi) = \texttt{pctx}(\tyof {\occ e \varpi} \Gamma)[\vec s]$.
    
    We proceed by induction on $\varpi$.\\

\end{document}