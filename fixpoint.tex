\documentclass[a4paper]{article}

\usepackage{setup}

\hypersetup{pdfstartview=XYZ}%         zoom par defaut

\setlength{\droptitle}{-5em}   % This is your set screw
\title{\vspace{1.5cm}Type inference - M2 Internship}
\author{Mickael LAURENT}
\date{\vspace{-5ex}}

\pagenumbering{gobble}

\theoremstyle{definition}
\newtheorem{theorem}{Theorem}
\newtheorem{lemma}{Lemma}
\newtheorem{definition}{Definition}
\newtheorem{property}{Property}
\newtheorem{corollary}{Corollary}

\begin{document}

    \maketitle

    \section{Typing system}

    \[
      \begin{array}{lrcl}
      \textbf{Types} & t & ::= & b\alt \arrow t t\alt \pair t t\alt t\vee t \alt \neg t \alt \Empty\\
      \textbf{Atoms} & t_A & ::= & b\alt \arrow t t\alt \pair t t\\
      \textbf{Non-Functional Types} & t_b & ::= & b \alt \pair {t_b} {t_b} \alt t_b\vee t_b \alt \neg t_b \alt \Empty\\
      \textbf{Normal Types} & \hat t & ::= & t_b \alt \arrow {\hat t} {\hat t}\alt \hat t \wedge \hat t \alt \hat t\vee \hat t
      \end{array}
    \]

    \[
      \norm t = \text{remove negative arrows from DNF}
    \]

    \[
    \begin{array}{lcl}
      \typep+\epsilon{\Gamma,e,t} & = & t\\
      \typep-\epsilon{\Gamma,e,t} & = & \neg t\\
      \typep{p}{\varpi.0}{\Gamma,e,t} & = & \neg(\arrow{\Gp p{\Gamma,e,t}{(\varpi.1)}}{\neg \Gp p {\Gamma,e,t} (\varpi)})\\
      \typep{p}{\varpi.1}{\Gamma,e,t} & = & \worra{\tyof{\occ e{\varpi.0}}\Gamma}{\Gp p {\Gamma,e,t} (\varpi)}\\
      \typep{p}{\varpi.l}{\Gamma,e,t} & = & \bpl{\Gp p {\Gamma,e,t} (\varpi)}\\
      \typep{p}{\varpi.r}{\Gamma,e,t} & = & \bpr{\Gp p {\Gamma,e,t} (\varpi)}\\
      \typep{p}{\varpi.f}{\Gamma,e,t} & = & \pair{\Gp p {\Gamma,e,t} (\varpi)}\Any\\
      \typep{p}{\varpi.s}{\Gamma,e,t} & = & \pair\Any{\Gp p {\Gamma,e,t} (\varpi)}\\ \\
      \Gp p {\Gamma,e,t} (\varpi) & = & \norm {\typep p \varpi {\Gamma,e,t} \land \tyof {\occ e \varpi} \Gamma
      \underbrace{\land \tyof {\occ e \varpi} {\Gamma\setminus\{\occ e \varpi\}}}_\text{if $\occ e \varpi$ is not a variable}}\\
    \end{array}
    \]

    \begin{align*}
      &(\Refine p {e,t} \Gamma)(e') = 
        \left\{\begin{array}{ll}
          \bigwedge_{\{\varpi \alt \occ e \varpi \equiv e'\}} \Gp p {\Gamma,e,t} (\varpi) & \text{if } \exists \varpi.\ \occ e \varpi \equiv e' \\
          \Gamma(e') & \text{otherwise, if } e' \in \dom \Gamma\\
          \text{undefined} & \text{otherwise}
        \end{array}\right.\\&\\
      &\Gaux {\varnothing} \Gamma = \Gamma\\
      &\Gaux {\cons {(e,t)} \tenv} \Gamma = \Gaux \tenv {\Refine p {e,t} \Gamma}\\&\\
      &\Genv \tenv \Gamma=\fixpoint_\Gamma (\Gaa \tenv)\qquad \text{(if defined)}
    \end{align*}

    \begin{mathpar}

        \Infer[Occ]
            {
            }
            { \tenv,\Gamma \vdash e: \Gamma(e) }
            { e\in\dom\Gamma}
        \qquad
        \Infer[Const]
            { }
            {\tenv,\Gamma\vdash c:\basic{c}}
            {c\not\in\dom\Gamma}
         \\
        \Infer[Abs]
            {\tenv,\Gamma,x:s_i\vdash e:t_i'\\t_i'\leq t_i}
            {
            \tenv,\Gamma\vdash\lambda^{\wedge_{i\in I}\arrow {s_i} {t_i}}x.e:\textstyle\bigwedge_{i\in I}\arrow {s_i} {t_i}
            }
            {\lambda^{\wedge_{i\in I}\arrow {s_i} {t_i}}x.e\not\in\dom\Gamma}
            \\
        \Infer[App]
            {
              \tenv,\Gamma \vdash e_1: t_1\\
              \tenv,\Gamma \vdash e_2: t_2\\
              t_1 \leq \arrow \Empty \Any\\
              t_2 \leq \dom {t_1}
            }
            { \tenv,\Gamma \vdash {e_1}{e_2}: t_1 \circ t_2 }
            { {e_1}{e_2}\not\in\dom\Gamma}
            \\
        \Infer[If]
              {\tenv,\Gamma\vdash e:t_0\\
              \makebox{$\begin{array}{l}
                \left\{
                  \begin{array}{ll} %\Gamma,
                  \cons {(e,t,+)} \tenv,\Genv {\cons {(e,t,+)} \tenv} \Gamma \vdash e_1 : t_1 & \text{ if } t_0 \not\leq \neg t\\
                  t_1 = \Empty & \text{ otherwise}
                \end{array}\right.\\
                \left\{
                  \begin{array}{ll} %\Gamma,
                  \cons {(e,t,-)} \tenv,\Genv {\cons {(e,t,-)} \tenv} \Gamma \vdash e_2 : t_2 & \text{ if } t_0 \not\leq t\\
                  t_2 = \Empty & \text{ otherwise}
                \end{array}\right.
              \end{array}$}}
              {\tenv,\Gamma\vdash \ite {e} t {e_1}{e_2}: t_1\vee t_2}
              %{\ite {e} t {e_1}{e_2}\not\in\dom\Gamma}
              {\texttt{if}\dots\not\in\dom\Gamma}
        \\
        \Infer[Proj]
        {\tenv,\Gamma \vdash e:t\and t\leq\pair\Any\Any}
        {\tenv,\Gamma \vdash \pi_i e:\bpi_{\mathbf{i}}(t)}
        {\pi_i e\not\in\dom\Gamma}

        \Infer[Pair]
        {\tenv,\Gamma \vdash e_1:t_1 \and \tenv,\Gamma \vdash e_2:t_2}
        {\tenv,\Gamma \vdash (e_1,e_2):\pair{t_1}{t_2}}
        {(e_1,e_2)\not\in\dom\Gamma}
    \end{mathpar}

    \section{Definitions}
      
    \begin{definition}[Well formed environment]
      An environment $\Gamma$ is well-formed iff:
      \begin{align*}
        &\forall e \in \dom \Gamma.\ e \text{ is normal (it has a DNF without negative arrow)}\\
        &\forall e \in \dom \Gamma \text{ not a variable. } \exists t.\ \Gamma\setminus(e:\Gamma(e)) \vdash e : t \text{ and } \Gamma(e) \leq t
      \end{align*}
      In particular, this last property implies:
      \[
        \forall e \in \dom \Gamma.\ \forall t.\ \Gamma\setminus(e:\Gamma(e)) \vdash e : t \Rightarrow \Gamma(e) \leq t
      \]
    \end{definition}
  
    \begin{definition}[Environment inclusion]
      Let $\Gamma$ and $\Gamma'$ two well-formed environments. We says that $\Gamma' \leq \Gamma$ iff:
      \begin{align*}
        &\forall e \in \dom \Gamma.\ \Gamma' \vdash e : t \text{ with } t \leq \Gamma(e)
      \end{align*}
    \end{definition}

    \begin{definition}[DNF]
      A disjonctive normal form $\tau$ is a finite set of pairs of finite sets atoms such that:
      \[ \forall (P,N)\in \tau.\ \semantic {\bigwedge_{t_A \in P} t_A \land \bigwedge_{t_A \in N} \neg t_A} \neq \varnothing \]

      The interpretation $\semantic \tau$ of $\tau$ is the following:
      \[
        \semantic \tau = \semantic {\bigvee_{(P,N)\in \tau} \left(\bigwedge_{t_A \in P} t_A \land \bigwedge_{t_A \in N} \neg t_A \right)}
      \]
    \end{definition}
    
    \begin{definition}[Plinth]
      A plinth $S$ is a set of types such that:
      \begin{itemize}
        \item $S$ is finite.
        \item $\Empty \in S$ and $S$ is stable by $\neg, \land, \vee$. 
        \item If $\tau$ is a DNF of $t\in S$, let's introduce $A=\{t_a \alt \exists (P,N) \in \tau \text{ s.t. } t_a \in P \text{ or } t_a \in N \}$. Thus:
        \begin{itemize}
          \item For all $t_a \in A$, we have $t_a \in S$.
          \item For all $t_1$, $t_2$ such that $\arrow {t_1} {t_2} \in A$ or $\pair {t_1} {t_2} \in A$,
          we have $t_1 \in S$ and $t_2 \in S$.
        \end{itemize}
      \end{itemize}
    \end{definition}

    \section{Theorems}

        \begin{lemma}[$\Ga {} $ well-formedness]
          Let $\Gamma$ a well-formed environment. Let $\tenv$ a set of tests.\\
          If $\Genv \tenv \Gamma$ is defined, then it is well-formed.
        \end{lemma}
    
        \begin{lemma}[$\Ga {} $ existence]
          Let $\Gamma$ a well-formed environment. Let $\tenv$ a set of tests such that for each test $(e,t,p)$, $e$ is well-typed in $\Gamma$.\\
          If the monotonicity lemma is true for every subexpression of every test, then $\Ga {}$ is well-defined.
        \end{lemma}

        \begin{lemma}[Monotonicity]
          Let $\tenv$ a (well-typed) set of tests.
          Let $\Gamma$ and $\Gamma'$ two well-formed environments such that $\Gamma' \leq \Gamma$.
          Let $e$ an expression such that $\tenv, \Gamma \vdash e:t$.
          Then:\\
          \begin{align*}
            &\tenv, \Gamma' \vdash e:t' \text{ with } t' \leq t\\
            &\forall p \forall t' \forall \varpi.\ \Gp p {\Gamma',e,t'} (\varpi) \leq \Gp p {\Gamma,e,t'} (\varpi)
          \end{align*}
        \end{lemma}

        \begin{corollary}[Relation order]
          The relation $\leq$ on environements is a preorder.
        \end{corollary}

        \begin{theorem}[$\Ga {}$ existence]
            If $\Gamma$ is well-formed and $\tenv$ is well typed, then $\Genv \tenv \Gamma$ is well defined and well-formed.
        \end{theorem}

        \begin{property}
          For every type $t$, we can compute a DNF $\tau$ such that $\semantic t = \semantic \tau$.
        \end{property}

        \begin{theorem}
          Every finite set of types is included in a plinth.
        \end{theorem}
        Proof: Alain Frisch thesis, theorem 3.8 (p64) [TODO: ref].

        \begin{theorem}[$\Ga {}$ computation]
          $\Genv \tenv \Gamma=\fixpoint_\Gamma (\Gaa \tenv)$ can be reached in a finite number of iterations.
        \end{theorem}

    \section{Proofs}

    \subsection{$\Ga {}$ definition}

    \subsection{Monotonicity}
    
      We proceed by induction on $e$. We suppose that, for any $e'$ strict subexpression of $e$, for any $\Gamma' \leq \Gamma$,
      \begin{align*}
        &\Gamma \vdash e':t' \Rightarrow \Gamma' \vdash e':t'' \text{ with } t'' \leq t'\\
        &\Gamma \vdash e':t' \Rightarrow \forall p \forall t'' \forall \varpi.\ \Gp p {\Gamma',e',t''} (\varpi) \leq \Gp p {\Gamma,e',t''} (\varpi)
      \end{align*}
  
      Let $\tenv$, $\Gamma$, $\Gamma'$ and $e$ as in the lemma statement.

      First, let's show that $\Gamma' \vdash e:t' \text{ with } t' \leq t$.
  
      If $e\in\dom\Gamma$, we know that $\Gamma(e)=t$ (as $\Gamma \vdash e:t$). The definition of $\Gamma' \leq \Gamma$ suffices to conclude.
      So let's suppose $e\not\in\dom\Gamma$ (in particular, we know that $e$ is not a variable and that the last rule applied to type $\Gamma \vdash e:t$ is not $\Rule{Occ}$).
  
      We can also suppose $e\not\in\dom{\Gamma'}$. If it is not the case, we can just consider $\Gamma'\setminus(e:\Gamma'(e))$ instead of $\Gamma'$
      and obtain the wanted result on $\Gamma'$ by using its well-formedness.

      We now proceed by case analysis on $e$:
      \begin{description}
        \item[$c$] Trivial.
        \item[$x$] Impossible case, as we have already treated the rule $\Rule{Occ}$.
        \item[$\lambda^{\bigwedge_{i\in I} \arrow {s_i} {t_i}}x.e_x$] We know that the last rule in the typing derivation of $\Gamma \vdash e:t$ is $\Rule {Abs}$.
        Let's build a derivation for $\Gamma' \vdash e:t'$ (with $t'\leq t$) with $\Rule {Abs}$ as last rule.
        For that, we just have to notice that $\forall i.\ \Gamma',x:s_i \leq \Gamma,x:s_i$ and we apply the induction hypothesis.
        Note that if $x \in \dom \Gamma$ or $x \in \dom {\Gamma'}$, $\Gamma',x:s_i$ or $\Gamma,x:s_i$ could be not well-formed.
        In this case, we must alpha-rename the current lambda-abstraction.

        \item[$e_1\ e_2$] We know that the last rule in the typing derivation of $\Gamma \vdash e:t$ is $\Rule {App}$.
        We can build a derivation for $\Gamma' \vdash e:t'$ (with $t'\leq t$) with $\Rule {App}$ as last rule.
        For that, we just have to apply the induction hypothesis and notice that the $\circ$ operator is monotonic.
        \item[$\ite {e_0} {t_{if}} {e_1} {e_2}$]
        We know that the last rule in the typing derivation of $\Gamma \vdash e:t$ is $\Rule {If}$.

        Let's build a derivation for $\Gamma' \vdash e:t'$ (with $t'\leq t$) with $\Rule {If}$ as last rule.

        By the $\Ga {}$ existence theorem, we know that $\Genv {\cons {(e_0,t_{if},p)} \tenv} {\Gamma'}$ is defined and well-formed.

        We can deduce that $\Genv {\cons {(e_0,t_{if},p)} \tenv} {\Gamma'} \leq \Genv {\cons {(e_0,t_{if},p)} \tenv} \Gamma$.

        Again we can conclude by applying the induction hypothesis.\\
      \end{description}
  
      Now, let's show that $\forall p \forall t' \forall \varpi.\ \Gp p {\Gamma',e,t'} (\varpi) \leq \Gp p {\Gamma,e,t'} (\varpi)$.
  
      Let $p\in \{+,-\}$ and $t'$ a type.
      We proceed by induction on $\varpi$.
      
      The base case is straightforward:\\
      we have $\tyof {\occ e \varpi} {\Gamma'} \leq \tyof {\occ e \varpi} {\Gamma}$ (we just proved it)
      and similarly $\tyof {\occ e \varpi} {\Gamma'\setminus\{\occ e \varpi\}} \leq \tyof {\occ e \varpi} {\Gamma\setminus\{\occ e \varpi\}}$.\\
      For the case $\varpi.1$, we apply the outer induction hypothesis to get $\tyof {\Gamma'} {\occ e {\varpi.0}} \leq \tyof {\Gamma} {\occ e {\varpi.0}}$.
      We apply the induction hypothesis to get $\Gp p {\Gamma',e,t'} (\varpi) \leq \Gp p {\Gamma,e,t'} (\varpi)$. We can then conclude using the monotonicity of $\worra {} {}$.\\
      The case $\varpi.0$ follows from the previous case and the induction hypothesis.
  
      \qed


    \subsection{$\Ga {}$ computation}

    Let $\Gamma$ (well-formed) and $\tenv$ (well-typed).

    Let's prove that we can reach $\Genv \tenv \Gamma=\fixpoint_\Gamma (\Gaa \tenv)$ by applying successively the function $\Gaa \tenv$ a finite number of times.\\
    In this proof, we will suppose that there is no occurence of a $\texttt{if}$ expression in any of the tested expressions
    (but there can be a $\texttt{if}$ subexpression if it is inside a lambda).

    We will show that, starting from $\Gamma$, successive applications of $\Gaa \tenv$ stay in a finite set of environments.

    Let's consider a finite set of types $T$ such that:
    \begin{itemize}
      \item $\forall (e,t) \in \tenv$, $t \in T$
      \item $\forall (e,t) \in \tenv\ \forall \varpi$, if $\occ e \varpi$ is a lambda abstraction $\lambda^tx.e_x$, then $t \in T$
      \item $\forall (e,t) \in \tenv\ \forall \varpi$, if $\occ e \varpi$ is a constant $c$, then $\basic{c} \in T$
      \item $\forall (e,t) \in \tenv\ \forall \varpi$, if $\occ e \varpi \in \dom \Gamma$, then $\Gamma(\occ e \varpi) \in T$
    \end{itemize}

    Using the previous theorem, let $S$ by a plinth such that $T \subseteq S$. In particular we know that $S$ is finite.

    We define the "product context" of a type $t$ by:
    \[
      \texttt{pctx}(t)=\left\{
        \begin{array}{ll}
          \pair {\texttt{pctx}(\bpl t)} {\texttt{pctx}(\bpr t)} & \text{ if } t \leq \pair \Any \Any\\
          {[}] & \text{ otherwise}
        \end{array}  
      \right.
    \]

    Let's prove the following invariant. After any number of iteration, the resulting environment $\Gamma'$ is such that:\\
    $\forall (e,t) \in \tenv\ \forall \varpi$, if $\occ e \varpi \in \dom {\Gamma'}$, then there exists $\vec s$ a vector of elements of $S$ s.t. $\Gamma'(\occ e \varpi) = \texttt{pctx}(\tyof {\occ e \varpi} \Gamma)[\vec s]$.
    
    We prove it by induction on the number of iterations.

    The base case (0 iteration) is trivial.

    For the inductive case, let's take $\Gamma'$ (well-formed) that satifies the induction hypothesis
    and show that $\Gamma'' = \Gaux \tenv {\Gamma'}$ also satisfies the induction hypothesis.

    Let's fix $(e,t)$ and $\varpi$.\\
    We need to show that there exists $\vec s$ a vector of elements of $S$ such that $\Gp p {\Gamma'',e,t} (\varpi) = \texttt{pctx}(\tyof {\occ e \varpi} \Gamma)[\vec s]$.
    
    We proceed by induction on $\varpi$.

    Before treating the base case and the inductive case, we have to show that both $\tyof {\occ e \varpi} {\Gamma'}$
    and $\tyof {\occ e \varpi} {\Gamma'\setminus\{\occ e \varpi\}}$ (if relevant) are equal to $\texttt{pctx}(\tyof {\occ e \varpi} \Gamma)[\vec s]$ for a certain $\vec s$ of $S$.

    It can be easily proven by induction on the derivation.\\
    The last rule can't be $\Rule{If}$ (we have assumed it before).\\
    If the last rule is $\Rule{App}$, we proceed by induction and by noticing that plinths are stable by $\circ$.\\
    Other rules are trivial.

    Now, the base case of our induction (for $\varpi=\epsilon$) becomes trivial.

    Here are the inductive cases:
    \begin{description}
      \item[$\varpi.0$] Although a new arrow type is created, it is a negative one and so it will disappear after normalisation.
      \item[$\varpi.1$] We just have to notice that plinths are stable by $\worra {} {}$.
      \item[$\varpi.l$ and $\varpi.r$] Trivial (as $\Gamma$ is well-formed, we have $\texttt{pctx}(\occ e {\varpi}) = \pair {\texttt{pctx}(\occ e {\varpi.l})} {\dots}$).
      \item[$\varpi.f$ and $\varpi.s$] Trivial (as $\Gamma$ is well-formed, we have $\texttt{pctx}(\occ e {\varpi.f}) = \pair {\texttt{pctx}(\occ e {\varpi})} {\dots}$).
    \end{description}

    It concludes the induction.

    So we can deduce that there is finitely many possible environements that can be produced by the successive applications of $\Gaa \tenv$.
    As $\Gaa \tenv$ is reductive, we always reach a fixpoint in a finite number of iterations.
    By construction, this fixpoint is the greatest (as $\Gaa \tenv$ is reductive and monotonic).

\end{document}