\documentclass[a4paper]{article}

\usepackage{setup}

\hypersetup{pdfstartview=XYZ}%         zoom par defaut

\setlength{\droptitle}{-5em}   % This is your set screw
\title{\vspace{1.5cm}Type inference - M2 Internship}
\author{Mickael LAURENT}
\date{\vspace{-5ex}}

\pagenumbering{gobble}

\theoremstyle{definition}
\newtheorem{theorem}{Theorem}
\newtheorem{lemma}{Lemma}
\newtheorem{definition}{Definition}
\newtheorem{property}{Property}
\newtheorem{corollary}{Corollary}

\begin{document}

    \maketitle

    \section{Type refinement system}

    \[
    \begin{array}{lcl}
      \typep+\epsilon{\Gamma,e,t} & = & t\\
      \typep-\epsilon{\Gamma,e,t} & = & \neg t\\
      \typep{p}{\varpi.0}{\Gamma,e,t} & = & \neg(\arrow{\Gp p{\Gamma,e,t}{(\varpi.1)}}{\neg \Gp p {\Gamma,e,t} (\varpi)})\\
      \typep{p}{\varpi.1}{\Gamma,e,t} & = & \worra{\tsrep {\tyof{\occ e{\varpi.0}}\Gamma}}{\Gp p {\Gamma,e,t} (\varpi)}\\
      \typep{p}{\varpi.l}{\Gamma,e,t} & = & \bpl{\Gp p {\Gamma,e,t} (\varpi)}\\
      \typep{p}{\varpi.r}{\Gamma,e,t} & = & \bpr{\Gp p {\Gamma,e,t} (\varpi)}\\
      \typep{p}{\varpi.f}{\Gamma,e,t} & = & \pair{\Gp p {\Gamma,e,t} (\varpi)}\Any\\
      \typep{p}{\varpi.s}{\Gamma,e,t} & = & \pair\Any{\Gp p {\Gamma,e,t} (\varpi)}\\ \\
      \Gp p {\Gamma,e,t} (\varpi) & = & \tsrep {\typep p \varpi {\Gamma,e,t} \tsand \tyof {\occ e \varpi} \Gamma}\\
      %\underbrace{\land \tyof {\occ e \varpi} {\Gamma\setminus\{\occ e \varpi\}}}_{\text{if $\occ e \varpi$ is not a variable}}}\\
    \end{array}
    \]

    \begin{align*}
      &(\Refine p {e,t} \Gamma)(e') = 
        \left\{\begin{array}{ll}
          \tyof {e'} \Gamma \tsand \bigwedge_{\{\varpi \alt \occ e \varpi \equiv e'\}} \Gp p {\Gamma,e,t} (\varpi) & \text{if } \exists \varpi.\ \occ e \varpi \equiv e' \\
          \Gamma(e') & \text{otherwise, if } e' \in \dom \Gamma\\
          \text{undefined} & \text{otherwise}
        \end{array}\right.\\&\\
      &\Gaux {\varnothing} \Gamma = \Gamma\\
      &\Gaux {\cons {(e,t)} \tenv} \Gamma = \Gaux \tenv {\Refine p {e,t} \Gamma}\\&\\
      &\Genv \tenv \Gamma=\fixpoint_\Gamma (\Gaa \tenv)\qquad \text{(if defined)}
    \end{align*}

    \begin{align*}
      \begin{array}{llclr}
      \text{If } e \in \dom \Gamma \text{, } & \tyof x \Gamma &=& \Gamma(x)\\
      & \tyof e \Gamma &=& \Gamma(e) \tsand \tyof e {\Gamma\setminus\{e\}}\\
      \text{Otherwise,} & \tyof c \Gamma &=& \basic{c}\\
      &\tyof {\lambda^{t}x.e} \Gamma &=& t\\
      &\tyof {{e_1} {e_2}} \Gamma &=& \apply {\tyof {e_1} \Gamma} {\tyof {e_2} \Gamma} & \text{(if defined)}\\
      &\tyof {\pi_i e} \Gamma &=& \bpi_{\mathbf{i}}(\tyof e \Gamma) & \text{(if defined)}\\
      &\tyof {(e_1,e_2)} \Gamma &=& \tyof {e_1} \Gamma \tstimes \tyof {e_2} \Gamma\\%\pair{\tyof {e_1} \Gamma}{\tyof {e_2} \Gamma}
      &\tyof {e} \Gamma &=& \tsempty & \text{(if other rules do not apply)}
    \end{array}
    \end{align*}

    \comment{
      \begin{mathpar}

        \Infer[Occ]
            {
            }
            { \Gamma \tvdash e: \Gamma(e) }
            { e\in\dom\Gamma}
        \qquad
        \Infer[Const]
            { }
            {\Gamma\tvdash c:\basic{c}}
            {c\not\in\dom\Gamma}
        \qquad
        \Infer[Abs]
            { }
            {
            \Gamma\tvdash\lambda^{t}x.e:t
            }
            {\lambda^{t}x.e\not\in\dom\Gamma}
            \\
        \Infer[App]
            {
              \Gamma \tvdash e_1: t_1\\
              \Gamma \tvdash e_2: t_2\\
              t_1 \leq \arrow \Empty \Any\\
              t_2 \leq \dom {t_1}
            }
            { \Gamma \tvdash {e_1}{e_2}: t_1 \circ t_2 }
            { {e_1}{e_2}\not\in\dom\Gamma }
            \\
        \Infer[Proj]
        {\Gamma \tvdash e:t\and t\leq\pair\Any\Any}
        {\Gamma \tvdash \pi_i e:\bpi_{\mathbf{i}}(t)}
        {\pi_i e\not\in\dom\Gamma}

        \Infer[Pair]
        {\Gamma \tvdash e_1:t_1 \and \Gamma \tvdash e_2:t_2}
        {\Gamma \tvdash (e_1,e_2):\pair{t_1}{t_2}}
        {(e_1,e_2)\not\in\dom\Gamma}
    \end{mathpar}
    }
  
    \section{Definitions}
      
    \begin{definition}[Well-formed environment]
      An environment $\Gamma$ is well-formed iff:
      \begin{align*}
        &\forall e \in \dom \Gamma \text{ not a variable. } \tsint{\tyof {e} {\Gamma\setminus\{e\}}} \neq \varnothing \text{ and } \tsint {\tyof {e} {\Gamma\setminus\{e\}}} \subseteq \tsint{\Gamma(e)}
      \end{align*}
    \end{definition}
  
    \begin{definition}[Environment inclusion]
      Let $\Gamma$ and $\Gamma'$ two well-formed environments. We says that $\Gamma' \leq \Gamma$ iff:
      \begin{align*}
        &\forall e \in \dom \Gamma.\ \tsint{\Gamma(e)} \subseteq \tsint{\tyof e {\Gamma'}}
      \end{align*}
    \end{definition}
    
    \begin{definition}[Plinth]
      A plinth $S$ is a set of types such that:
      \begin{itemize}
        \item $S$ is finite.
        \item $\Empty \in S$ and $S$ is stable by $\neg, \land, \vee$. 
        \item If $\tau$ is a DNF of $t\in S$, let's introduce $A=\{t_a \alt \exists (P,N) \in \tau \text{ s.t. } t_a \in P \text{ or } t_a \in N \}$. Thus:
        \begin{itemize}
          \item For all $t_a \in A$, we have $t_a \in S$.
          \item For all $t_1$, $t_2$ such that $\arrow {t_1} {t_2} \in A$ or $\pair {t_1} {t_2} \in A$,
          we have $t_1 \in S$ and $t_2 \in S$.
        \end{itemize}
      \end{itemize}
    \end{definition}

    \section{Theorems}

        \begin{lemma}[$\Ga {} $ well-formedness]
          Let $\Gamma$ a well-formed environment. Let $\tenv$ a set of tests.\\
          If $\Genv \tenv \Gamma$ is defined, then it is well-formed.
        \end{lemma}

        \begin{lemma}[$\tyof {} {}$ monotonicity] TODO: update\\
          Let $\Gamma$ and $\Gamma'$ two well-formed environments such that $\Gamma' \leq \Gamma$.
          Let $e$ an expression and $t$ a type.\\
          If $\tyof e \Gamma = t$, then $\tyof e {\Gamma'} \leq t$.
        \end{lemma}

        \begin{corollary}[Relation order]
          The relation $\leq$ on environements is a preorder.
        \end{corollary}

        \begin{lemma}[$\Gaa {} $ existence] TODO: update\\
          Let $\Gamma$ a well-formed environment.
          Let $\tenv$ a set of tests such that for each test $(e,t,p)$, $e$ is well-typed in $\Gamma$ (according to $\tyof {} {}$).\\
          Then $\Gaux \tenv \Gamma$ is well-defined.
        \end{lemma}

        \begin{lemma}[$\Gaa {}$ monotonicity]
          Let $\Gamma$ and $\Gamma'$ two well-formed environments such that $\Gamma' \leq \Gamma$.
          Let $\tenv$ a set of well-typed tests. Then, $\Gaux \tenv {\Gamma'} \leq \Gaux \tenv \Gamma$.
        \end{lemma}

        \begin{theorem}[$\Ga {}$ existence]
            If $\Gamma$ is well-formed and $\tenv$ is well typed, then $\Genv \tenv \Gamma$ is well defined and well-formed.
        \end{theorem}

        \begin{theorem}
          Every finite set of types is included in a plinth.
        \end{theorem}
        Proof: Alain Frisch thesis, theorem 3.8 (p64) [TODO: ref].

        \begin{theorem}[$\Ga {}$ computation]
          $\Genv \tenv \Gamma=\fixpoint_\Gamma (\Gaa \tenv)$ can be reached in a finite number of iterations.
        \end{theorem}

    \section{Proofs}

    \subsection{$\Gaa {}$ monotonicity}

      Let $\tenv$, $\Gamma$, $\Gamma'$ as in the lemma statement.

      We just have to prove that for all relevant $p$, $e$, $t$ and $\varpi$, we have $\Gp p {\Gamma',e,t} (\varpi) \leq \Gp p {\Gamma,e,t} (\varpi)$.

      We proceed by induction on $\varpi$. 

      As $\Gamma\setminus\{\occ e \varpi\}$ and $\Gamma'\setminus\{\occ e \varpi\}$ are well-formed and $\Gamma\setminus\{\occ e \varpi\} \leq \Gamma'\setminus\{\occ e \varpi\}$ (trivial),
      we get by monotonicity $\tyof {\occ e \varpi} {\Gamma'\setminus\{\occ e \varpi\}} \leq \tyof {\occ e \varpi} {\Gamma\setminus\{\occ e \varpi\}}$.
      Similarly, we have $\tyof {\occ e \varpi} {\Gamma'} \leq \tyof {\occ e \varpi} {\Gamma}$.

      Now, we proceed by case analysis on $\varpi$:
      \begin{description}
        \item[$\epsilon$] Trivial.
        \item[$\varpi.0$] We use the induction hypothesis and the contravariance/covariance of $\arrow {} {}$.
        \item[$\varpi.1$] We use the induction hypothesis.\\
        First, we must show that the $\worra {} {}$ operator is monotonic for its second argument.
        It is quite trivial given its declarative definition.

        Secondly, we must show that ... TODO
        \item[$\varpi.l$ or $\varpi.r$] We use the induction hypothesis and the monotonicity of $\bpi_{\mathbf{i}}$.
        \item[$\varpi.f$ or $\varpi.s$] We use the induction hypothesis and the covariance of $\pair {} {}$.
      \end{description}
    
      \qed

    \subsection{$\Ga {}$ computation}

    TODO: update (no more normalization, operators on type schemes)

    Let $\Gamma$ (well-formed) and $\tenv$ (well-typed).

    Let's prove that we can reach $\Genv \tenv \Gamma=\fixpoint_\Gamma (\Gaa \tenv)$ by applying successively the function $\Gaa \tenv$ a finite number of times.

    We will show that, starting from $\Gamma$, successive applications of $\Gaa \tenv$ stay in a finite set of environments.

    Let's consider a finite set of types $T$ such that:
    \begin{itemize}
      \item $\forall (e,t) \in \tenv$, $t \in T$
      \item $\forall (e,t) \in \tenv\ \forall \varpi$, if $\occ e \varpi$ is a lambda abstraction $\lambda^tx.e_x$, then $t \in T$
      \item $\forall (e,t) \in \tenv\ \forall \varpi$, if $\occ e \varpi$ is a constant $c$, then $\basic{c} \in T$
      \item $\forall (e,t) \in \tenv\ \forall \varpi$, if $\occ e \varpi \in \dom \Gamma$, then $\Gamma(\occ e \varpi) \in T$
    \end{itemize}

    Using the previous theorem, let $S$ by a plinth such that $T \subseteq S$. In particular we know that $S$ is finite.

    We define the "product context" of a type $t$ by:
    \[
      \texttt{pctx}(t)=\left\{
        \begin{array}{ll}
          \pair {\texttt{pctx}(\bpl t)} {\texttt{pctx}(\bpr t)} & \text{ if } t \leq \pair \Any \Any\\
          {[}] & \text{ otherwise}
        \end{array}  
      \right.
    \]

    Let's prove the following invariant. After any number of iteration, the resulting environment $\Gamma'$ is such that:\\
    $\forall (e,t) \in \tenv\ \forall \varpi$, if $\occ e \varpi \in \dom {\Gamma'}$, then $\Gamma'(\occ e \varpi)$ has a DNF with only atoms of the form
    $\texttt{pctx}(\tyof {\occ e \varpi} \Gamma)[\vec s]$ (with any vector $\vec s$ of elements of $S$).
    Note that there is finitely many such atoms.
    
    We prove it by induction on the number of iterations.

    The base case (0 iteration) is trivial.

    For the inductive case, let's take $\Gamma'$ (well-formed) that satifies the induction hypothesis
    and show that $\Gamma'' = \Gaux \tenv {\Gamma'}$ also satisfies the induction hypothesis.

    Let's fix $(e,t)$ and $\varpi$.\\
    We need to show that there exists $\vec s$ a vector of elements of $S$ such that $\Gp p {\Gamma'',e,t} (\varpi) = \texttt{pctx}(\tyof {\occ e \varpi} \Gamma)[\vec s]$.
    
    We proceed by induction on $\varpi$.

    Before treating the base case and the inductive case, we have to show that both $\tyof {\occ e \varpi} {\Gamma'}$
    and $\tyof {\occ e \varpi} {\Gamma'\setminus\{\occ e \varpi\}}$ (if relevant) have DNF with only atoms of the form
    $\texttt{pctx}(\tyof {\occ e \varpi} \Gamma)[\vec s]$ (with any vector $\vec s$ of elements of $S$).

    It can be easily proven by induction on the derivation.\\
    If the last rule is $\Rule{App}$, we proceed by induction and by noticing that plinths are stable by $\circ$.\\
    Other rules are trivial.

    Now, the base case of our induction (for $\varpi=\epsilon$) becomes trivial.

    Here are the inductive cases:
    \begin{description}
      \item[$\varpi.0$] Although a new arrow type is created, it is a negative one and so it will disappear after normalisation.
      \item[$\varpi.1$] We just have to notice that plinths are stable by $\worra {} {}$.
      \item[$\varpi.l$ and $\varpi.r$] Trivial (as $\Gamma$ is well-formed, we have $\texttt{pctx}(\occ e {\varpi}) = \pair {\texttt{pctx}(\occ e {\varpi.l})} {\dots}$).
      \item[$\varpi.f$ and $\varpi.s$] Trivial (as $\Gamma$ is well-formed, we have $\texttt{pctx}(\occ e {\varpi.f}) = \pair {\texttt{pctx}(\occ e {\varpi})} {\dots}$).
    \end{description}

    It concludes the induction.

    So we can deduce that there is finitely many possible environements that can be produced by the successive applications of $\Gaa \tenv$.
    As $\Gaa \tenv$ is reductive, we always reach a fixpoint in a finite number of iterations.
    By construction, this fixpoint is the greatest (as $\Gaa \tenv$ is reductive and monotonic).

\end{document}