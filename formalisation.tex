% Header
\documentclass[a4paper]{article}%      autres choix : book, report
\usepackage[utf8]{inputenc}%           gestion des accents (source)
\usepackage[T1]{fontenc}%              gestion des accents (PDF)
\usepackage[francais]{babel}%          gestion du francais
\usepackage{textcomp}%                 caracteres additionnels
\usepackage{mathtools,amssymb,amsthm}% packages de l'AMS + mathtools
\usepackage{lmodern}%                  police de caractere
\usepackage[top=2cm,left=2cm,right=2cm,bottom=2cm]{geometry}%     gestion des marges
\usepackage{graphicx}%                 gestion des images
\usepackage{array}%                    gestion amelioree des tableaux
\usepackage{calc}%                     syntaxe naturelle pour les calculs
\usepackage{titlesec}%                 pour les sections
\usepackage{titletoc}%                 pour la table des matieres
\usepackage{fancyhdr}%                 pour les en-tetes
\usepackage{titling}%                  pour le titre
\usepackage{enumitem}%                 pour les listes numerotees
\usepackage{hyperref}%                 gestion des hyperliens
\usepackage{syntax}
\usepackage{minted}
\usepackage[parfill]{parskip}
\usepackage{amsmath}
\usepackage{fourier}
\usepackage{heuristica}
\usepackage[overload]{empheq}
\usepackage{cleveref} 
\usemintedstyle{vs}

\hypersetup{pdfstartview=XYZ}%         zoom par defaut

\setlength{\droptitle}{-5em}   % This is your set screw
\title{\vspace{1.5cm}Type inference - M2 Internship}
\author{Mickael LAURENT}
\date{\vspace{-5ex}}

\pagenumbering{gobble}
\DeclarePairedDelimiter\ceil{\lceil}{\rceil}
\DeclarePairedDelimiter\floor{\lfloor}{\rfloor}

\DeclareFontFamily{U}{mathb}{}
\DeclareFontShape{U}{mathb}{m}{n}{
  <-5.5> mathb5
  <5.5-6.5> mathb6
  <6.5-7.5> mathb7
  <7.5-8.5> mathb8
  <8.5-9.5> mathb9
  <9.5-11.5> mathb10
  <11.5-> mathb12
}{}
\DeclareSymbolFont{mathb}{U}{mathb}{m}{n}
\DeclareMathSymbol{\sqdot}{\mathbin}{mathb}{"0D}
\newcommand{\worra}[2]{#1\mathop{\,\sqdot\,} #2}
\newcommand{\apply}[2]{#1\circ#2}
\newcommand{\dom}[1]{\textsf{dom}(#1)}
\newcommand{\alt}{~|~}
\newcommand{\Empty} {\textsf{Empty}}%\MyMathBb{0}}
\newcommand{\Any} {\textsf{Any}}%\MyMathBb{1}}

\begin{document}

	\maketitle

    \section{Typing}

    \subsection{Open Records}

    \begin{grammar}
        \let\syntleft\relax
        \let\syntright\relax
        <e> ::= <e>.field \alt \{field=<e>\} \alt <e>+<e>
    \end{grammar}

    $ \omega \in \{0,1,c_{field},a_{field},p_1,p_2\} $

    \begin{align*} 
        e.field \downarrow a_{field}\cdot\omega & = e \downarrow \omega\\
        \{field=e\} \downarrow c_{field}\cdot\omega & = e \downarrow \omega\\
        e_1 + e_2 \downarrow p_i \cdot \omega & = e_i \downarrow \omega
    \end{align*}

    \begin{align*}
        p_1^v(t) &= ?\\
        p_2^u(t) &= ?\\
        \text{proj}_{field}(t) &= \min\{u | t \leq \{field:u\}\}
    \end{align*}

    \begin{align*}
        t_{\Gamma,e,t}(\omega\cdot c_{field}) &= \text{proj}_{field}(t_{\Gamma,e,t}(\omega) \land \{field:Any\})\\
        t_{\Gamma,e,t}(\omega\cdot a_{field}) &= \{ field: t_{\Gamma,e,t}(\omega) \}\\
        t_{\Gamma,e,t}(\omega\cdot p_1) &=  p_1^{\text{typeof}_{\Gamma}(\omega\cdot p_2)}(t_{\Gamma,e,t}(\omega))\\
        t_{\Gamma,e,t}(\omega\cdot p_2) &=  p_2^{\text{typeof}_{\Gamma}(\omega\cdot p_1)}(t_{\Gamma,e,t}(\omega))
    \end{align*}

    Problem: $p_1^v$ and $p_2^u$. Even if computable, non interesting result: we need to know exactly fields in the right operand
    if we want a more interesting results!

    \subsection{Open Records (2nd try)}

    \begin{grammar}
        \let\syntleft\relax
        \let\syntright\relax
        <e> ::= <e>.field \alt \{\} \alt \{<e> with field=<e>\} \alt \{<e> with field=\O\}
    \end{grammar}

    $ \omega \in \{0,1,a_{field},u_{field}^1,u_{field}^2,r_{field}\} $

    \begin{align*}
        \text{proj}_{field}(\bigvee\limits_{i \in I}
        (\bigwedge\limits_{p \in Pi} \{f_p:t_p\} \bigwedge\limits_{n \in Ni} \neg \{f_n:t_n\}))
        &= \bigvee\limits_{i \in I}
        (\bigwedge\limits_{\substack{p \in Pi \\ f_p = field}} t_p \bigwedge\limits_{\substack{n \in Ni \\ f_n = field}} \neg t_n)\\
        \text{forget}_{field}(\bigvee\limits_{i \in I}
        (\bigwedge\limits_{p \in Pi} \{f_p:t_p\} \bigwedge\limits_{n \in Ni} \neg \{f_n:t_n\}))
        &= \bigvee\limits_{i \in I}
        (\bigwedge\limits_{\substack{p \in Pi \\ f_p \neq field}} \{f_p:t_p\} \bigwedge\limits_{\substack{n \in Ni \\ f_n \neq field}} \neg \{f_n:t_n\})\\
    \end{align*}

    \begin{align*}
        t_{\Gamma,e,t}(\omega\cdot a_{field}) &= \{ field: t_{\Gamma,e,t}(\omega) \}\\
        t_{\Gamma,e,t}(\omega\cdot u_{field}^1) &= \text{forget}_{field}(t_{\Gamma,e,t}(\omega) \land \{field=\text{typeof}_{\Gamma}(\omega \cdot u_{field}^2)\})\\
        t_{\Gamma,e,t}(\omega\cdot u_{field}^2) &= \text{proj}_{field}(t_{\Gamma,e,t}(\omega) \land \{\})\\
        t_{\Gamma,e,t}(\omega\cdot r_{field}) &= \text{forget}_{field}(t_{\Gamma,e,t}(\omega) \land \{\} \land \neg \{field=Any\})
    \end{align*}

    \subsection{Open/Closed Records with CDuce notation}

    \begin{grammar}
        \let\syntleft\relax
        \let\syntright\relax
        <e> ::= <e>.label \alt \{\} \alt \{..\} \alt \{<e> with label=<e>\} \alt <e>\textbackslash label
    \end{grammar}

    \begin{align*}
        t_{\Gamma,e,t}(\omega\cdot a_{label}) &= \{ label: t_{\Gamma,e,t}(\omega) \ .. \}\\
        t_{\Gamma,e,t}(\omega\cdot u_{label}^1) &= t_{\Gamma,e,t}(\omega) \land \{label=\text{typeof}_{\Gamma}(\omega \cdot u_{label}^2) \ .. \} + \{ label =? Any \}\\
        t_{\Gamma,e,t}(\omega\cdot u_{label}^2) &= \Pi_{label}(t_{\Gamma,e,t}(\omega) \land \{label=\text{typeof}_{\Gamma}(\omega \cdot u_{label}^2) \ .. \})\\
        t_{\Gamma,e,t}(\omega\cdot r_{label}) &= t_{\Gamma,e,t}(\omega) \land \{\} \land \neg \{label=Any \ .. \} + \{ label =? Any \}
    \end{align*}

    \section{Proofs}

    \subsection{Recall: some definitons}

    \[ \worra t s = \min \{ u \leq \dom t \alt \apply t {(\dom t \setminus u)} \leq \neg s \} \]

    \[ t \simeq \bigvee_{i\in I}\left(\bigwedge_{p\in P_i}(s_p\to t_p)\bigwedge_{n\in N_i}\neg(s_n'\to t_n')\right) \]

    \begin{eqnarray*}
        \dom{t}    & = & \bigwedge_{i\in I}\bigvee_{p\in P_i}s_p\\[4mm]
        \apply t s & = & \bigvee_{i\in I}\left(\bigvee_{\{Q\subsetneq P_i\alt s\not\leq\bigvee_{q\in Q}s_q\}}\left(\bigwedge_{p\in P_i\setminus Q}t_p\right)\right)\hspace*{1cm}\makebox[0cm][l]{(for $s\leq\dom{t}$)}\\[4mm]
        \worra t s & = & \dom t \wedge\bigvee_{i\in I}\left(\bigvee_{\{p\in P_i\alt s\wedge t_p\not=\varnothing\}}s_p \setminus \bigvee_{\{p\in P_i\alt s\wedge t_p=\varnothing\}}s_p \right)
    \end{eqnarray*}
    \pagebreak

    \subsection{Correctness of worra}
    
    Let $t$ an arrow type. $t \simeq \bigvee_{i\in I}\left(\bigwedge_{p\in P_i}(s_p\to t_p)\bigwedge_{n\in N_i}\neg(s_n'\to t_n')\right)$\\
    Let $s$ a be any type.

    Let's prove that $\apply t {(\dom t \setminus (\worra t s))} \leq \neg s$ with the algorithmic definition for $\worra {} {}$.\\
    Equivalently, we want $(\apply t {(\dom t \setminus (\worra t s))}) \land s = \varnothing$.\\

    Let $u$ be a type such that $u \leq \dom t$ and $(\apply t u) \land s \neq \varnothing$ (if such a type does not exist, we are done).\\
    Let's show that $u \land (\worra t s) \neq \varnothing$ (we can easily deduce the wanted property from that, by the absurd).\\
    For that, we should prove the following:\\

    \begin{subequations}
        \begin{align}[left ={\exists i \in I. \exists u' \leq u. \empheqlbrace}]
          &u' \land \bigvee_{\{p\in P_i\alt s\wedge t_p\not=\varnothing\}}s_p \neq \varnothing\label{eq1a}\\
          &u' \land \bigvee_{\{p \in P_i \alt s \land t_p = \varnothing\}}s_p = \varnothing\label{eq1b}
        \end{align}
    \end{subequations}

  From $(\apply t u) \land s \neq \varnothing$, we can take (using the algorithmic definition of $\circ$) $i \in I$ and $Q \subsetneq P_i$ such that:\\
  \[ u \not\leq\bigvee_{q\in Q}s_q \text{\ \ \ and\ \ \ } (\bigwedge_{p\in P_i\setminus Q}t_p) \land s \neq \varnothing \]

    First, let's focus on \cref{eq1b}.\\
    For any $p \in P_i$ such that $s \land t_p = \varnothing$, we have $p \in Q$ (by the absurd, because $(\bigwedge_{p\in P_i\setminus Q}t_p) \land s \neq \varnothing$).\\
    We can deduce that:
    \[ \bigvee_{\{p \in P_i \alt s \land t_p = \varnothing\}}s_p \leq \bigvee_{q \in Q}s_q \]
    Moreover, as $u \not\leq\bigvee_{q\in Q}s_q$, we have $u \not\leq\bigvee_{\{p \in P_i \alt s \land t_p = \varnothing\}}s_p$.\\
    So let's take $u' = u \setminus \bigvee_{\{p \in P_i \alt s \land t_p = \varnothing\}}s_p$ ($\neq \varnothing$).\\
    By definition, we have $u' \land \bigvee_{\{p \in P_i \alt s \land t_p = \varnothing\}}s_p = \varnothing$.\\
 
    Now, let's focus on \cref{eq1a}.\\
    Recall that we have:
    \[ \bigvee_{\{p \in P_i \alt s \land t_p = \varnothing\}}s_p \leq \bigvee_{q \in Q}s_q 
    \text{\ \ \ and\ \ \ } u \not\leq\bigvee_{q\in Q}s_q \]
    Thus:
    \[ u' \setminus \left(\bigvee_{q \in Q}s_q\right) = \left(u \setminus \bigvee_{\{p \in P_i \alt s \land t_p = \varnothing\}}s_p\right) \setminus \left(\bigvee_{q \in Q}s_q\right) = u \setminus \left(\bigvee_{q \in Q}s_q\right) \neq \varnothing \]
    So we have $ u' \not\leq\bigvee_{q\in Q}s_q $. We also know, from $u \leq \dom t$, that $u' \leq u \leq \bigvee_{p\in P_i}s_p$.\\

    We deduce that:
    \[ u' \land \bigvee_{p\in P_i \setminus Q}s_p \neq \varnothing \]

    Moreover, as $(\bigwedge_{p\in P_i\setminus Q}t_p) \land s \neq \varnothing$, we know that all $p \in P_i \setminus Q$ verify $s \land t_p \neq \varnothing$.\\
    Thus, we have $u' \land \bigvee_{\{p\in P_i\alt s\wedge t_p\not=\varnothing\}}s_p \neq \varnothing$, which ends the proof.
    
    \qed

    \pagebreak

    \subsection{Optimality of worra}

    Let $t$ an arrow type. $t \simeq \bigvee_{i\in I}\left(\bigwedge_{p\in P_i}(s_p\to t_p)\bigwedge_{n\in N_i}\neg(s_n'\to t_n')\right)$\\
    Let $s$ a be any type.

    Let $u$ be such that $\apply t {(\dom t \setminus u)} \leq \neg s$. We want to prove that $\worra t s \leq u$.

    \[\worra t s = \dom t \wedge\bigvee_{i\in I}\left(\bigvee_{\{p\in P_i\alt s\wedge t_p\not=\varnothing\}}s_p \setminus \bigvee_{\{p\in P_i\alt s\wedge t_p=\varnothing\}}s_p \right)\]
    For any $i \in I$ and $p \in P_i$ such that $s \land t_p \neq \varnothing$, we define $a_{i,p}=\dom t \land (s_p \setminus \bigvee_{\{p'\in P_i\alt s\wedge t_{p'}=\varnothing\}}s_{p'}) \leq u$.\\
    Note that \[\worra t s = \bigvee_{\substack{i \in I\\ \{p \in P_i \alt s \land t_p \neq \varnothing\}}} a_{i,p} \]

    Let $i \in I$ and $p \in P_i$ such that $s \land t_p \neq \varnothing$.\\
    We just have to show that $a = a_{i,p} \leq u$.

    By the absurd, let's suppose that $a \land \neg u \neq \varnothing$ and show that $(\apply t {(\dom t \setminus u)}) \land s \neq \varnothing$.\\

    Let's take $Q = \min \{ Q \subset (P_i \setminus \{p\}) \alt s \land \bigwedge_{p' \in P_i\setminus Q} t_{p'} \neq \varnothing \}$ with $\min$ refering to the set inclusion order.\\
    Note that this $\min$ is not really well defined as there may be many minimal $Q$ satisfying this condition, but in this case we can take any of them.     We know that a such $Q$ exists because $s \land t_p \neq \varnothing$.\\

    As by definition $s \land \bigwedge_{p'\in P_i\setminus Q}t_{p'} \neq \varnothing$, all we have to prove in order to deduce $(\apply t {(\dom t \setminus u)}) \land s \neq \varnothing$ is:\\
    \[ \dom t \setminus u \not\leq \bigvee_{q\in Q}s_q \]

    As $ \dom t \setminus u \geq a \land \neg u$, it suffices to prove the following:
    \[ a \land \neg u \land (\bigwedge_{q\in Q} \neg s_q) \neq \varnothing \]

    Let's suppose by the absurd that $a \land \bigvee_{q\in Q} s_q \neq \varnothing$.\\
    Let $Q' = \{p'\in P_i\alt s\wedge t_{p'}=\varnothing\}$.

    By definition of $Q$, we have $Q' \land (P_i \setminus Q) = \varnothing$.\\
    Thus, $Q' \setminus Q = \varnothing$ and so $Q' \subset Q$.

    Moreover, we know that $a \land \bigvee_{\{p'\in P_i\alt s\wedge t_{p'}=\varnothing\}} s_{p'} = \varnothing$ (definition of $a_{i,p}$).\\ % and $a \leq s_p$
    So we have $Q' \neq Q$ because $a \land \bigvee_{q\in Q} s_q \neq \varnothing$ and $a \land \bigvee_{p'\in Q'} s_{p'} = \varnothing$.

    It gives $Q' \subsetneq Q$.

    As $Q'$ is such that $s \land \bigwedge_{p' \in P_i\setminus Q'} t_{p'} \neq \varnothing$ (???), we have a contradiction with the minimality of $Q$.

    Hence, $a \leq \bigwedge_{q\in Q} \neg s_q$. As we also know that $a \land \neg u \neq \varnothing$, we can deduce the wanted inequality.

\end{document}