\documentclass[a4paper]{article}

\usepackage{setup}

\hypersetup{pdfstartview=XYZ}%         zoom par defaut

\setlength{\droptitle}{-5em}   % This is your set screw
\title{\vspace{1.5cm}Descriptive type system}
\author{}
\date{\vspace{-5ex}}

\pagenumbering{gobble}

\theoremstyle{definition}
\newtheorem{theorem}{Theorem}
\newtheorem{lemma}{Lemma}
\newtheorem{definition}{Definition}
\newtheorem{property}{Property}
\newtheorem{corollary}{Corollary}

\begin{document}

  \maketitle
  
    \section{Definitions}

      \begin{definition}[Environment inclusion]
        Let $\Gamma$ and $\Gamma'$ two environments. We say that $\Gamma' \leq \Gamma$ iff:
        \begin{align*}
          &\forall e \in \dom \Gamma.\ \Gamma' \vdash e : \Gamma(e)
        \end{align*}
      \end{definition}
    
      \begin{definition}[Environment substitution]
        Let $\Gamma$ an environment and $\rho$ a substitution from variables to expressions.
        The environment $\Gamma\rho$ is defined by:
        \begin{align*}
          &\dom {\Gamma\rho} = \dom \Gamma \rho\\
          &\forall e \in \dom {\Gamma\rho}, (\Gamma\rho)(e) = \bigwedge_{\{e' \in \dom \Gamma \alt e'\rho\equiv e\}}\Gamma(e')
        \end{align*}
      \end{definition}
    
      \begin{definition}[Ordinary environments]
        We say that an environment $\Gamma$ is ordinary iff its domain only contains variables.
      \end{definition}

    \section{Theorems}

        \begin{property}[$\valsemantic \_$ properties]
          \begin{align*}
            &\forall s.\ \forall t.\ \valsemantic s \subseteq \valsemantic t \Leftrightarrow s \leq t\\
            &\valsemantic \Empty = \varnothing\\
            &\forall t.\ \valsemantic {\neg t} = \values \setminus \valsemantic t\\
            &\forall s.\ \forall t.\ \valsemantic {s\vee t} = \valsemantic s \cup \valsemantic t
          \end{align*}
        \end{property}
        Proof: theorem 5.5, lemmas 6.19, 6.22, 6.23 of semantic_subtyping [TODO: ref].

        \begin{lemma}[Alpha-renaming]
          Both the type system and the semantics are invariant by alpha-renaming.
        \end{lemma}
        Proof: quite straightforward.
        For the type system, it is a consequence of the fact that environments are up to alpha-renaming.
        For the semantics, it is a consequence of the fact that parallel substitutions (for the case of the $\texttt{if}$)
        are up to alpha-renaming.
    
        \begin{lemma}[Monotonicity]
          Let $\Gamma$ and $\Gamma'$ two environments such that $\Gamma' \leq \Gamma$.
          Then, we have:
          \begin{align*}
            \forall e,t.\ &\Gamma \vdash e:t \Rightarrow \Gamma' \vdash e:t\\
            \forall e,t,p,e',t'.\ &\Gamma \cvdash p e t e':t' \Rightarrow \Gamma' \cvdash p e t e':t'\\
            \forall e,t,p,\varpi,t'.\ &\pvdash \Gamma p e t \varpi:t' \Rightarrow \pvdash {\Gamma'} p e t \varpi:t'
          \end{align*}
        \end{lemma}

        \begin{corollary}[Relation order]
          The relation $\leq$ on environements is a preorder.
        \end{corollary}
    
        \begin{corollary}[Strengthening]
          If $\Gamma, (x:t_1^x) \vdash e:t_1$ and $\Gamma, (x:t_2^x) \vdash e:t_2$, then
          $\Gamma, (x:t_1^x \land t_2^x) \vdash e:t_1\land t_2$.
        \end{corollary}
        Proof: use the \Rule{Intersect} rule and the monotonicity lemma.

        \begin{lemma}[Value typing]
          Let $v$ a value and $\Gamma$ an environment such that $v$ is well-typed in $\Gamma$ (we can derive a type for $v$).
          Then, for any expression $e$, type $t$ and for any $p\in\{+,-\}$, we have:
          \[\forall t',\ \Gamma \vdash v:t' \Leftrightarrow \Gamma \cvdash p e t v:t'\]
          In other words, a test cannot strictly refine the type of a value.

          A consequence is that for any derivable judgement, we can construct a derivation that
          never use the rule \Rule{Path} with $\occ e \varpi$ refering to a value.
        \end{lemma}

        \begin{lemma}[Substitution]
          Let $\Gamma$ an environment. Let $e_a$ and $e_b$ two expressions.

          Let's suppose that $e_b$ is a closed term and that $e_a$ has one of the following form:
          \begin{itemize}
            \item $x$ (variable)
            \item $v$ (value)
            \item $v v$ (value applied to a value)
          \end{itemize}
          Let's also suppose that $\forall t'.\ \Gamma \vdash e_a : t' \Rightarrow \Gamma\subst {e_a} {e_b} \vdash e_b:t'$.
          
          Then, by noting $\rho = \subst {e_a} {e_b}$ we have:
          \begin{align*}
            \forall e,t.\ &\Gamma \vdash e:t \Rightarrow \Gamma\rho \vdash e\rho:t\\
            \forall e,t,p,e',t'.\ &\Gamma \cvdash p {e} {t} e':t' \Rightarrow \Gamma\rho \cvdash p {e\rho} {t} e'\rho:t'\\
            \forall e,t,p,\varpi,t'.\ &\pvdash \Gamma p e t \varpi:t' \text{ and }\occ {e\rho} \varpi\text{ is defined} \Rightarrow \pvdash {\Gamma\rho} p {e\rho} t \varpi:t'
          \end{align*}
        \end{lemma}

        \begin{theorem}[Subject reduction]
          Let $\Gamma$ an ordinary environment, $e$ and $e'$ two expressions and $t$ a type.

          If $\Gamma\vdash e:t$ and $e\leadsto e'$, then $\Gamma\vdash e':t$.
        \end{theorem}

        \section{Proofs}

        \subsection{Monotonicity lemma}

        Let $\Gamma$ and $\Gamma'$ such that $\Gamma' \leq \Gamma$.

        We proceed by induction on the derivation of the judgment.

        We proceed by case analysis on the last rule of the derivation:
        
        \begin{description}
          \item[\Rule{Occ}] We use the definition of $\Gamma' \leq \Gamma$.
          \item[TODO] 
        \end{description}

        \subsection{Substitution lemma}

        Let $\Gamma$, $e_a$, $e_b$ as in the statement.

        We note $\rho$ the substitution $\subst {e_a} {e_b}$.

        We consider a derivation of the judgement in the hypotheses (left-side of the implications).

        By using the value typing lemma, we can assume without loss of generality that this derivation
        never uses the rule \Rule{Path} with $\occ e \varpi$ refering to a value.

        We can also assume w.l.o.g. that all rules \Rule{Path} satisfy
        $\occ e \varpi \in\dom\Gamma \Rightarrow t_1 \leq \Gamma(\occ e \varpi)$ (if it is not the case,
        we can transform the derivation using \Rule{PIntersect}, \Rule{PTypeof}, \Rule{Occ} and \Rule{Subs}).

        We now proceed by induction on this derivation in order to produce the required derivation.
        
        If the last judgement is of the form $\Gamma \vdash e_a: t$, then we can directly conclude with the hypotheses of the lemma.
        Thus, we can suppose it is not the case.

        There are many cases depending on the last rule:

        \begin{description}
          \item[\Rule{Occ}] If $e\in\dom\Gamma$, then we have $e\rho\in\dom{\Gamma\rho}$ and $(\Gamma\rho)(e\rho)\leq\Gamma(e)$.
          Thus we can easily derive $\Gamma\rho\vdash e\rho:t$ with the rule \Rule{Occ} and \Rule{Subs}.
          \item[\Rule{Intersect}] Trivial (by using the induction hypothesis).
          \item[\Rule{Subs}] Trivial (by using the induction hypothesis).
          \item[\Rule{Const}] In this case, $c\rho = c$ (because $c \neq e_a$). So it is trivial.
          \item[\Rule{App}] We have $(e_1 e_2)\rho = (e_1\rho) (e_2\rho)$ (because $e_1 e_2 \neq e_a$).
          So it is trivial (by using the induction hypothesis).
          \item[\Rule{Abs}] We have $(\lambda^{t'}x.e)\rho = \lambda^{t'}x.(e\rho)$ (because $\lambda^{t'}x.e \neq e_a$).
          
          By alpha-renaming, we can suppose that the variable $x$ is a new fresh variable that does not appear
          in $e_a$ nor $e_b$ ($e_b$ is closed).
          
          We can thus use the induction hypothesis on all the judgements $\Gamma, x:s_i \vdash e:t_i$.
          \item[\Rule{If}]
          We have $(\ite e t {e_1} {e_2})\rho = \ite {e\rho} t {e_1\rho} {e_2\rho}$ (because $\ite e t {e_1} {e_2} \neq e_a$).

          We apply the induction hypothesis on the judgement $\Gamma\vdash e:t_0$.
          We get that $\Gamma\rho\vdash e\rho:t_0$.

          If we have $t_0\not\leq\neg t$, we can apply the induction hypothesis on the judgment $\Gamma\cvdash + e t e_1:t'$.
          It gives us a derivation for $\Gamma\rho\cvdash + {e\rho} t e_1\rho:t'$.

          Similarly, if we have $t_0\not\leq t$, we can get a derivation for $\Gamma\rho\cvdash - {e\rho} t e_2\rho:t'$.
          \item[\Rule{Base}] Trivial (by using the induction hypothesis).
          \item[\Rule{Path}] There are three cases:
          \begin{itemize}
            \item $\occ e \varpi$ is a strict subexpression of $e_a$.
            
            In this case, it means that among its three possible forms,
            $e_a$ is of the form $v v$. Thus, $\occ e \varpi$ is a value.
            It contradicts an assumption we made on the derivation.

            \item $\occ e \varpi$ is not a subexpression of $e_a$.
            
            In this case, we know that $\occ {e\rho} \varpi$ is defined.
            We have by using the induction hypothesis $\pvdash {\Gamma\rho} p {e\rho} t \varpi:t_1$.

            Let's show that $\forall t'.\ \Gamma,(\occ e \varpi:t_1) \vdash e_a : t' \Rightarrow (\Gamma,(\occ e \varpi:t_1))\rho \vdash e_b:t'$.
            
            Let $t'$ such that $\Gamma,(\occ e \varpi:t_1) \vdash e_a : t'$.

            As $\occ e \varpi$ is not a subexpression of $e_a$, the derivation of
            $\Gamma,(\occ e \varpi:t_1) \vdash e_a : t'$ never uses the rule \Rule{Occ} on the expression $\occ e \varpi$,
            and so we can easily transform this derivation into a valid derivation for $\Gamma \vdash e_a : t'$.
 
            Thus, we get $\Gamma\rho \vdash e_b : t'$ (by using the hypotheses of this lemma).
            Moreover, we have $(\Gamma,(\occ e \varpi:t_1))\rho \leq \Gamma\rho$
            (we made the assumption that $t_1 \leq \Gamma(\occ e \varpi)$ for all rules \Rule{Path}).
            Thus, we can derive $(\Gamma,(\occ e \varpi:t_1))\rho\vdash e_b : t'$ using the monotonicity lemma.

            Now, we can apply the induction hypothesis on the derivation of $\Gamma,(\occ e \varpi:t_1) \vdash e' : t_2$.
            We obtain $(\Gamma,(\occ e \varpi:t_1))\rho \vdash e'\rho : t_2$.
            Together with $\pvdash {\Gamma\rho} p {e\rho} t \varpi:t_1$, it allows us to construct the wanted derivation using the
            \Rule{Path} rule.

            \item $\occ e \varpi = e_a$
            
            This case is similar to the previous.
            The only difference is the way to deduce $(\Gamma,(\occ e \varpi:t_1))\rho \vdash e_b:t'$ from $\Gamma,(\occ e \varpi:t_1) \vdash e_a : t'$.

            Indeed, we can't derive $\Gamma \vdash e_a : t'$ from $\Gamma,(\occ e \varpi:t_1) \vdash e_a : t'$ because $\occ e \varpi (= e_a)$
            is not a strict subexpression of $e_a$ and thus the rule \Rule{Occ} could be used on $\occ e \varpi (= e_a)$ in the initial derivation.

            However, the rule \Rule{Occ} can only be used on $e_a$ at the bottom of the derivation of $\Gamma,(e_a:t_1) \vdash e_a : t'$:
            there can't be any \Rule{App}, \Rule{Abs} or \Rule{If} after because the premises of these rules only contain strict subexpressions of their
            consequence. The only rules that can appear in a branch containing a \Rule{Occ} applied on $e_a$ are \Rule{Occ}, \Rule{Subs} and \Rule{Intersect}.

            Thus, we can (temporarily) remove from the derivation all these branchs
            (for each \Rule{Occ} we want to remove, we go down until we have an \Rule{Intersect} rule,
            we remove this \Rule{Intersect} rule and replace it by its other premise).

            It gives us a derivation for $\Gamma,(e_a:t_1) \vdash e_a : t''$ such that $t''\land t_1 \leq t'$ and without any \Rule{Occ} applied to $e_a$.
            Thus, we can transform it into a derivation of $\Gamma \vdash e_a : t''$ and we get $\Gamma\rho \vdash e_b : t''$ (from the hypotheses of the lemma).

            Using the monotonicity lemma, we get a derivation for $(\Gamma,(e_a:t_1))\rho\vdash e_b : t''$.
            We can then append at the end of this derivation an \Rule{Intersect} with a \Rule{Occ} (applied to $e_b$).
            As $((\Gamma,(e_a:t_1))\rho)(e_b) \leq t_1$, we obtain a derivation
            for $(\Gamma,(e_a:t_1))\rho\vdash e_b : t'$ (we can add a final \Rule{Subs} rule if needed).
            
          \end{itemize}

          \item[\Rule{PTypeof}] Trivial (by using the induction hypothesis).
          \item[\Rule{P$\cdots$}] All the remaining rules are trivial.
        \end{description}

        \subsection{Subject reduction}

        Let $\Gamma$, $e$, $e'$ and $t$ as in the statement.

        We construct a derivation for $\Gamma \vdash e':t$ by induction on the derivation of $\Gamma \vdash e:t$.

        We proceed by case analysis on the last rule of the derivation:
        
        \begin{description}
          \item[\Rule{Occ}] As $\Gamma$ is ordinary, it means that $e$ is a variable.
          It contradicts the fact that $e$ reduces to $e'$ so this case is impossible. 
          \item[\Rule{Intersect}] Trivial (by using the induction hypothesis).
          \item[\Rule{Subs}] Trivial (by using the induction hypothesis).
        \end{description}

\end{document}