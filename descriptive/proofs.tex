\documentclass[a4paper]{article}

\usepackage{setup}

\hypersetup{pdfstartview=XYZ}%         zoom par defaut

\setlength{\droptitle}{-5em}   % This is your set screw
\title{\vspace{1.5cm}Descriptive type system}
\author{}
\date{\vspace{-5ex}}

\pagenumbering{gobble}

\theoremstyle{definition}
\newtheorem{theorem}{Theorem}
\newtheorem{lemma}{Lemma}
\newtheorem{definition}{Definition}
\newtheorem{property}{Property}
\newtheorem{corollary}{Corollary}

\begin{document}

  \maketitle
  
    \section{Definitions}

      \begin{definition}[Environment inclusion]
        Let $\Gamma$ and $\Gamma'$ two environments. We say that $\Gamma' \leq \Gamma$ iff:
        \begin{align*}
          &\forall e \in \dom \Gamma.\ \Gamma' \vdash e : \Gamma(e)
        \end{align*}
      \end{definition}
    
      \begin{definition}[Environment substitution]
        Let $\Gamma$ an environment and $\rho$ a substitution from variables to expressions.
        The environment $\Gamma\rho$ is defined by:
        \begin{align*}
          &\dom {\Gamma\rho} = \dom \Gamma \rho\\
          &\forall e \in \dom {\Gamma\rho}, (\Gamma\rho)(e) = \bigwedge_{\{e' \in \dom \Gamma \alt e'\rho\equiv e\}}\Gamma(e')
        \end{align*}
      \end{definition}
    
      \begin{definition}[Ordinary environments]
        We say that an environment $\Gamma$ is ordinary iff its domain only contains variables.
      \end{definition}

    \section{Theorems}

        \begin{property}[$\valsemantic \_$ properties]
          \begin{align*}
            &\forall s.\ \forall t.\ \valsemantic s \subseteq \valsemantic t \Leftrightarrow s \leq t\\
            &\valsemantic \Empty = \varnothing\\
            &\forall t.\ \valsemantic {\neg t} = \values \setminus \valsemantic t\\
            &\forall s.\ \forall t.\ \valsemantic {s\vee t} = \valsemantic s \cup \valsemantic t
          \end{align*}
        \end{property}
        Proof: theorem 5.5, lemmas 6.19, 6.22, 6.23 of semantic_subtyping [TODO: ref].

        \begin{lemma}[Alpha-renaming]
          Both the type system and the semantics are invariant by alpha-renaming.
        \end{lemma}
        Proof: quite straightforward.
        For the type system, it is a consequence of the fact that environments are up to alpha-renaming.
        For the semantics, it is a consequence of the fact that parallel substitutions (for the case of the $\texttt{if}$)
        are up to alpha-renaming.
    
        \begin{lemma}[Monotonicity]
          Let $\Gamma$ and $\Gamma'$ two environments such that $\Gamma' \leq \Gamma$.
          Then, we have:
          \begin{align*}
            \forall e,t.\ &\Gamma \vdash e:t \Rightarrow \Gamma' \vdash e:t\\
            \forall e,t,p,e',t'.\ &\Gamma \cvdash p e t e':t' \Rightarrow \Gamma' \cvdash p e t e':t'\\
            \forall e,t,p,\varpi,t'.\ &\pvdash \Gamma p e t \varpi:t' \Rightarrow \pvdash {\Gamma'} p e t \varpi:t'
          \end{align*}
        \end{lemma}

        \begin{corollary}[Relation order]
          The relation $\leq$ on environements is a preorder.
        \end{corollary}
    
        \begin{corollary}[Strengthening]
          If $\Gamma, (x:t_1^x) \vdash e:t_1$ and $\Gamma, (x:t_2^x) \vdash e:t_2$, then
          $\Gamma, (x:t_1^x \land t_2^x) \vdash e:t_1\land t_2$.
        \end{corollary}
        Proof: use the \Rule{Intersect} rule and the monotonicity lemma.

        \begin{lemma}[Value typing]
          Let $v$ a value and $\Gamma$ an environment such that $v$ is well-typed in $\Gamma$ (we can derive a type for $v$).
          Then, for any expression $e$, type $t$ and for any $p\in\{+,-\}$, we have:
          \[\forall t',\ \Gamma \vdash v:t' \Leftrightarrow \Gamma \cvdash p e t v:t'\]
          In other words, a test cannot strictly refine the type of a value.

          A consequence is that for any derivable judgement, we can construct a derivation that
          never use the rule \Rule{Path} with $\occ e \varpi$ refering to a value.
        \end{lemma}

        \begin{lemma}[Substitution]
          Let $\Gamma$ an environment. Let $e_a$ and $e_b$ two expressions.

          Let's suppose that $e_b$ is a closed term and that $e_a$ has one of the following form:
          \begin{itemize}
            \item $x$ (variable)
            \item $v$ (value)
            \item $v v$ (value applied to a value)
          \end{itemize}
          Let's also suppose that $\forall t'.\ \Gamma \vdash e_a : t' \Rightarrow \Gamma\subst {e_a} {e_b} \vdash e_b:t'$.
          
          Then, by noting $\rho = \subst {e_a} {e_b}$ we have:
          \begin{align*}
            \forall e,t.\ &\Gamma \vdash e:t \Rightarrow \Gamma\rho \vdash e\rho:t\\
            \forall e,t,p,e',t'.\ &\Gamma \cvdash p {e} {t} e':t' \Rightarrow \Gamma\rho \cvdash p {e\rho} {t} e'\rho:t'\\
            \forall e,t,p,\varpi,t'.\ &\pvdash \Gamma p e t \varpi:t' \text{ and }\occ {e\rho} \varpi\text{ is defined} \Rightarrow \pvdash {\Gamma\rho} p {e\rho} t \varpi:t'
          \end{align*}
        \end{lemma}

        \section{Proofs}

        \subsection{Monotonicity lemma}

        Let $\Gamma$ and $\Gamma'$ such that $\Gamma' \leq \Gamma$.

        We proceed by induction on the last rule of the derivation of the judgment.

        We proceed by case analysis:
        
        \begin{description}
          \item[\Rule{Occ}] We use the definition of $\Gamma' \leq \Gamma$.
          \item[TODO] 
        \end{description}

        \subsection{Substitution lemma}

        Let $\Gamma$, $e$, $e_a$, $e_b$ and $t$ as in the statement.

        We note $\rho$ the substitution $\subst {e_a} {e_b}$.

        We proceed by induction on the last rule of the derivation of the judgment.

        By using the value typing lemma, we can assume without loss of generality that this derivation
        never uses the rule \Rule{Path} with $\occ e \varpi$ refering to a value.
        % TODO: remove comment below
        %We can also assume w.l.o.g. that all rules \Rule{Path} satisfy
        %$\occ e \varpi \in\dom\Gamma \Rightarrow t_1 \leq \Gamma(\occ e \varpi)$ (if it is not the case,
        %we can transform the derivation using \Rule{PTypeof}, \Rule{PIntersect} and \Rule{Subs}).

        \begin{description}
          \item[\Rule{Occ}] If $e\in\dom\Gamma$, then we have $e\rho\in\dom\Gamma\rho$ and $(\Gamma\rho)(e\rho)\leq\Gamma(e)$.
          Thus we can easily derive $\Gamma\rho\vdash e\rho:t$ with the rule \Rule{Occ} and \Rule{Subst}.
          \item[\Rule{Intersect}] Trivial (by using the induction hypothesis).
          \item[\Rule{Subs}] Trivial (by using the induction hypothesis).
          \item[\Rule{Const}] Trivial.
          \item[\Rule{App}] Trivial (by using the induction hypothesis).
          \item[\Rule{Abs}] By alpha-renaming, we can suppose that the variable $x$ of the $\lambda$-abstraction
          is a new fresh variable that does not appear in $e_a$ nor $e_b$ ($e_b$ is closed).
          
          We can thus use the induction hypothesis on all the judgements $\Gamma, x:s_i \vdash e:t_i$.
          \item[\Rule{If}] We apply the induction hypothesis on the judgement $\Gamma\vdash e:t_0$.
          We get that $\Gamma\rho\vdash e\rho:t_0$.

          If we have $t_0\not\leq\neg t$, we can apply the induction hypothesis on the judgment $\Gamma\cvdash + e t e_1:t'$.
          It gives us a derivation for $\Gamma\rho\cvdash + {e\rho} t e_1\rho:t'$.

          Similarly, if we have $t_0\not\leq t$, we can get a derivation for $\Gamma\rho\cvdash - {e\rho} t e_2\rho:t'$.
          \item[\Rule{Base}] Trivial (by using the induction hypothesis).
          \item[\Rule{Path}] There are three cases:
          \begin{itemize}
            \item $\occ e \varpi$ is a strict subexpression of $e_a$. In this case, it means that among its three possible forms,
            $e_a$ is of the form $v v$. Thus, $\occ e \varpi$ is a value.
            It contradicts the assumption we made on the derivation.

            \item $\occ e \varpi = e_a$ TODO

            \item $\occ e \varpi$ is not a subexpression of $e_a$.
            
            In this case, we know that $\occ {e\rho} \varpi$ is defined.
            We have by using the induction hypothesis $\pvdash {\Gamma\rho} p {e\rho} t \varpi:t_1$.

            Let's show that $\forall t'.\ \Gamma,(\occ e \varpi:t_1) \vdash e_a : t' \Rightarrow (\Gamma,(\occ e \varpi:t_1))\rho \vdash e_b:t'$.
            
            Let $t'$ such that $\Gamma,(\occ e \varpi:t_1) \vdash e_a : t'$.

            As $\occ e \varpi$ is not a subexpression of $e_a$, the derivation of
            $\Gamma,(\occ e \varpi:t_1) \vdash e_a : t'$ never uses the rule \Rule{Occ} on $(\occ e \varpi:t_1)$,
            and so we can easily transform this derivation into a valid derivation for $\Gamma \vdash e_a : t'$.
 
            Thus, we get $\Gamma\rho \vdash e_b : t'$. TODO: introduce [LSubs] rule and lemma. Use it here.

            As $\Gamma\rho,(\occ {e\rho} \varpi:t_1) = (\Gamma,(\occ e \varpi:t_1))\rho$,
            we deduce $(\Gamma,(\occ e \varpi:t_1))\rho \vdash e_b:t'$.

            Now, we use the induction hypothesis on $\Gamma,(\occ e \varpi:t_1) \vdash e' : t_2$
            and we obtain $(\Gamma,(\occ e \varpi:t_1))\rho \vdash e' : t_2$.
          \end{itemize} 
        \end{description}

\end{document}