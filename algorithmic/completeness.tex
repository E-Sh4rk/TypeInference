\documentclass[a4paper]{article}

\usepackage{setup}

\hypersetup{pdfstartview=XYZ}%         zoom par defaut

\setlength{\droptitle}{-5em}   % This is your set screw
\title{\vspace{1.5cm}Type inference - M2 Internship}
\author{Mickael LAURENT}
\date{\vspace{-5ex}}

\pagenumbering{gobble}

\theoremstyle{definition}
\newtheorem{theorem}{Theorem}
\newtheorem{lemma}{Lemma}
\newtheorem{definition}{Definition}
\newtheorem{property}{Property}
\newtheorem{corollary}{Corollary}

\begin{document}

  \maketitle

  \subsubsection{Some definitions}

    \begin{definition}[Bottom environment]
      Let $\Gamma$ an environment.\\
      $\Gamma$ is bottom (noted $\Gamma = \bot$) iff $\exists e\in\dom\Gamma.\ \Gamma(e)\simeq\Empty$.
    \end{definition}

    \begin{definition}[Algorithmic (pre)order on environments]
    Let $\Gamma$ and $\Gamma'$ two environments. We write $\Gamma' \leqA \Gamma$ iff:
    \begin{align*}
        &\Gamma'=\bot \text{ or } (\Gamma\neq\bot \text{ and } \forall e \in \dom \Gamma.\ \tyof e \Gamma \leq \Gamma(e))
    \end{align*}

    For an expression $e$, we write $\Gamma' \leqA^e \Gamma$ iff:
    \begin{align*}
      &\Gamma'=\bot \text{ or } (\Gamma\neq\bot \text{ and } \forall e' \in \dom \Gamma \text{ such that $e'$ is a subexpression of $e$}.\ \tyof {e'} \Gamma \leq \Gamma({e'}))
    \end{align*}

    Note that if $\Gamma' \leqA \Gamma$, then $\Gamma' \leqA^e \Gamma$ for any $e$.
    \end{definition}

    \begin{definition}[Order relation for type schemes]
      Let $\ts_1$ and $\ts_2$ two type schemes. We write $\ts_2 \leq \ts_1$ iff $\tsint {\ts_1} \subseteq \tsint{\ts_2}$.
    \end{definition}

    \begin{definition}[Positive derivation]
      A derivation of the declarative type system is said positive iff it does not contain any rule \Rule{Abs-}.
    \end{definition}

    \begin{definition}[Acceptable derivation]
      A derivation of the declarative type system is said acceptable iff any application of \Rule{PAppL}
      has a positive derivation as first premise ($\pvdash \Gamma e t \varpi.1:t_1$).
    \end{definition}

  \subsubsection{Major lemmas and completeness}

  \begin{lemma}
    \begin{align*}
      &\forall t,\ts.\ \tsrep{t\tsand\ts} \leq t \land \tsrep{\ts}\\
      &\forall \ts_1,\ts_2.\ \tsrep{\apply {\ts_1}{\ts_2}} \leq \apply {\tsrep {\ts_1}}{\tsrep {\ts_2}}
    \end{align*}
  \end{lemma}

  Proof: straightfoward, by induction on the structure of $\ts$.

  \begin{lemma}[Monotonicity of the algorithm] Let $\Gamma$, $\Gamma'$ and $e$ such that $\Gamma'\leqA^e \Gamma$ and $\tyof e \Gamma \neq \tsempty$. We have:
    \begin{align*}
      &\tyof e {\Gamma'} \leq \tyof e {\Gamma} \text{ and } \tsrep{\tyof e {\Gamma'}} \leq \tsrep{\tyof e {\Gamma}}\\
      &\forall t,\varpi.\ \env {\Gamma',e,t} (\varpi) \leq \env {\Gamma,e,t} (\varpi)\\
      &\forall t.\ \Refine {e,t} {\Gamma'} \leqA^e \Refine {e,t} \Gamma\\
    \end{align*}
  \end{lemma}

  Proof:

  We proceed by induction over the structure of $e$
  and, for two identical $e$, on the domains of $\Gamma$ and $\Gamma'$ (with the lexicographical inclusion order).

  Let's prove the first property: $\tyof e {\Gamma'} \leq \tyof e {\Gamma} \text{ and } \tsrep{\tyof e {\Gamma'}} \leq \tsrep{\tyof e {\Gamma}}$.
  We will focus on showing $\tyof e {\Gamma'} \leq \tyof e {\Gamma}$. The property $\tsrep{\tyof e {\Gamma'}} \leq \tsrep{\tyof e {\Gamma}}$
  can be proved in a very similar way, by using the fact that operators on type schemes like $\tsand$ or $\apply {} {}$ are also monotone.
  (Note that the only rule that introduces the type scheme constructor $\tsfun {\_}$ is \Rule{Abs\Aa}.)

  If $\Gamma' = \bot$ we can conclude directly with the rule \Rule{Efq}.
  So let's assume $\Gamma' \neq \bot$ and $\Gamma \neq \bot$
  (as $\Gamma = \bot \Rightarrow \Gamma' = \bot$ by definition of $\leqA^e$).

  If $e=x$ is a variable, then the last rule used in $\tyof e \Gamma$ and $\tyof e {\Gamma'}$ is \Rule{Var\Aa}.
  As $\Gamma' \leqA^e \Gamma$, we have $\Gamma'(e) \leq \Gamma(e)$ and thus
  we can conclude with the rule \Rule{Var\Aa}.
  So let's assume that $e$ is not a variable.

  If $e\in\dom\Gamma$, then the last rule used in $\tyof e \Gamma$ is \Rule{Env\Aa}.
  As $\Gamma' \leqA^e \Gamma$, we have $\tyof e {\Gamma'} \leq \Gamma(e)$.
  Moreover, by applying the induction hypothesis, we get $\tyof e {\Gamma'\setminus \{e\}} \leq \tyof e {\Gamma\setminus \{e\}}$
  (we can easily verify that $\Gamma'\setminus\{e\} \leqA^e \Gamma\setminus\{e\}$).
  \begin{itemize}
    \item If we have $e\in\dom{\Gamma'}$, we have according to the rule \Rule{Env\Aa}
    $\tyof e {\Gamma'} \leq \tyof e {\Gamma'\setminus \{e\}} \leq \tyof e {\Gamma\setminus \{e\}}$.
    Together with $\tyof e {\Gamma'} \leq \Gamma(e)$,
    we deduce $\tyof e {\Gamma'} \leq \Gamma(e) \tsand \tyof e {\Gamma\setminus \{e\}} = \tyof e {\Gamma}$.
    \item  Otherwise, we have $e\not\in\dom{\Gamma'}$. Thus
    $\tyof e {\Gamma'} = \tyof e {\Gamma'\setminus \{e\}} \leq \Gamma(e) \tsand \tyof e {\Gamma\setminus \{e\}}=\tyof e {\Gamma}$.
  \end{itemize}

  If $e\not\in\dom\Gamma$ and $e\in\dom{\Gamma'}$, the last rule is \Rule{Env\Aa} for $\tyof e {\Gamma'}$.
  As $\Gamma'\setminus\{e\} \leqA^e \Gamma\setminus\{e\} = \Gamma$,
  we have $\tyof e {\Gamma'} \leq \tyof e {\Gamma'\setminus \{e\}} \leq \tyof e {\Gamma}$ by induction hypothesis.

  Thus, let's suppose that $e\not\in\dom\Gamma$ and $e\not\in\dom{\Gamma'}$.
  From now we know that the last rule in $\tyof e {\Gamma}$ and $\tyof e {\Gamma'}$ is the same.

  \begin{description}
    \item[$e=c$] The last rule is \Rule{Const\Aa}. It does not depend on $\Gamma$ so this case is trivial.
    \item[$e=x$] Already treated.
    \item[$e=\lambda^{\bigwedge_{i\in I} \arrow {t_i}{s_i}}x.e'$]
    The last rule is \Rule{Abs\Aa}.
    We have $\forall i\in I.\ \Gamma', (x:s_i) \leqA^{e'} \Gamma, (x:s_i)$ (quite straightforward)
    so by applying the induction hypothesis we have $\forall i\in I.\ \tyof {e'} {\Gamma', (x:s_i)} \leq \tyof {e'} {\Gamma, (x:s_i)}$.

    \item[$e=e_1 e_2$] The last rule is \Rule{App\Aa}.
    We can conclude immediately by using the induction hypothesis and noticing that $\apply {} {}$ is monotonic for both of its arguments.

    \item[$e=\pi_i e'$] The last rule is \Rule{Proj\Aa}.
    We can conclude immediately by using the induction hypothesis and noticing that $\bpi_i$ is monotonic.
     
    \item[$e=(e_1,e_2)$] The last rule is \Rule{Pair\Aa}.
    We can conclude immediately by using the induction hypothesis.

    \item[$\ite {e_0} t {e_1} {e_2}$] The last rule is \Rule{Case\Aa}.
    By using the induction hypothesis we get $\Refine {e_0,t} {\Gamma'} \leqA^{e_0} \Refine {e_0,t} \Gamma$.
    We also have $\Gamma' \leqA^{e_1} \Gamma$ (as $e_1$ is a subexpression of $e$).

    From those two properties, let's show that we can deduce $\Refine {e_0,t} {\Gamma'} \leqA^{e_1} \Refine {e_0,t} \Gamma$:

    Let $e'\in\dom{\Refine {e_0,t} \Gamma}$ a subexpression of $e_1$.
    \begin{itemize}
      \item If $e'$ is also a subexpression of $e_0$, we can directly deduce
      $\tyof {e'} {\Refine {e_0,t} \Gamma'} \leq (\Refine {e_0,t} \Gamma) (e')$
      by using $\Refine {e_0,t} {\Gamma'} \leqA^{e_0} \Refine {e_0,t} \Gamma$.

      \item Otherwise, as $\Refine {e_0,t} {\_}$ is reductive,
      we have $\Refine {e_0,t} {\Gamma'} \leqA \Gamma'$ and thus by using the induction hypothesis
      $\tyof {e'} {\Refine {e_0,t} {\Gamma'}} \leq \tyof {e'} {\Gamma'}$.
      We also have $\tyof {e'} {\Gamma'} \leq \Gamma(e')$ by using $\Gamma' \leqA^{e_1} \Gamma$.
      We deduce $\tyof {e'} {\Refine {e_0,t} {\Gamma'}} \leq \Gamma(e') = (\Refine {e_0,t} \Gamma) (e')$.
    \end{itemize}
    
    So we have $\Refine {e_0,t} {\Gamma'} \leqA^{e_1} \Refine {e_0,t} \Gamma$.
    Consequently, we can apply the induction hypothesis again to get
    $\tyof {e_1} {\Refine {e_0,t} {\Gamma'}} \leq \tyof {e_1} {\Refine {e_0,t} {\Gamma}}$.

    We proceed the same way for the last premise.
  \end{description}\ \\

  Now, let's prove the second property.
  We perform a (nested) induction on $\varpi$.

  We know that $\tsrep{\tyof {\occ e \varpi} {\Gamma'}} \leq \tsrep{\tyof {\occ e \varpi} {\Gamma}}$
  by the outer induction hypothesis (for $\varpi=\epsilon$ we use the proof of the first property above).

  Thus we just have to prove that $\constr {\varpi} {\Gamma',e,t} \leq \constr {\varpi} {\Gamma,e,t}$.
  The only case that is interesting is the case $\varpi=\varpi'.1$.

  First, we can notice that the $\worra {} {}$ operator is monotonic for its second argument
  (consequence of its declarative definition).

  Secondly, let's show that for any function types $t_1 \leq t_2$, and for any type $t'$,
  we have $(\worra {t_1} {t'}) \land \dom {t_2} \leq \worra {t_2} {t'}$. By the absurd, let's suppose it is not true.
  Let's note $t'' = (\worra {t_1} {t'}) \land \dom {t_2}$.
  Then we have $t'' \leq \dom {t_2} \leq \dom {t_1}$ and $t_2 \leq \arrow {t''} {t'}$ and
  $t_1 \not\leq \arrow {t''} {t'}$, which contradicts $t_1 \leq t_2$.

  Let's note $t_1 = \tsrep {\tyof{\occ e{\varpi'.0}}{\Gamma'}}$ and $t_2 = \tsrep {\tyof{\occ e{\varpi'.0}}\Gamma}$
  and $t'=\env {\Gamma,e,t} (\varpi')$.
  As $e$ is well-typed, and using the inner induction hypothesis, we have $\tsrep {\tyof {\occ e {\varpi'.1}} {\Gamma'}} \leq \tsrep {\tyof {\occ e {\varpi'.1}} {\Gamma}} \leq \dom {t_2}$.\\
  Thus, using this property, we get:\\
  \begin{align*}
  &(\worra {t_1} {t'}) \land \tsrep {\tyof {\occ e {\varpi'.1}} {\Gamma'}}\\
  \leq &(\worra {t_2} {t'}) \land \tsrep {\tyof {\occ e {\varpi'.1}} {\Gamma}}
  \end{align*}

  Then, using the monotonicity of the second argument of $\worra {}{}$ and the outer induction hypothesis:
  \begin{align*}
    &(\worra {t_1} {\env {\Gamma',e,t} (\varpi')}) \land \tsrep {\tyof {\occ e {\varpi'.1}} {\Gamma'}}\\
    \leq &(\worra {t_2} {\env {\Gamma,e,t} (\varpi')}) \land \tsrep {\tyof {\occ e {\varpi'.1}} {\Gamma}}
  \end{align*}
  \\

  \ 

  Finally, we must prove the third property.\\
  It is straightforward by using the previous result and the induction hypothesis:\\
  for any $e'$ such that $\exists \varpi.\ \occ e \varpi \equiv e'$, we get
  $\bigwedge_{\{\varpi\alt \occ e \varpi \equiv e'\}} \env {\Gamma',e,t} (\varpi) \leq \bigwedge_{\{\varpi\alt \occ e \varpi \equiv e'\}} \env {\Gamma,e,t} (\varpi)$.

  The rest follows.

  \qed

  \begin{theorem}[Completeness of the algorithm for positive derivations]
    For any $\Gamma$, $e$, $t$ such that we have a positive derivation of $\Gamma \vdash e:t$,
    there exists a global parameter $n_o$ with which $\tsrep{\tyof e \Gamma} \leq t$.

    More precisely:
    \begin{align*}
      &\forall \Gamma, e, t.\ \Gamma \vdash e:t \text{ has a positive derivation } \Rightarrow \tsrep{\tyof e \Gamma} \leq t\\
      &\forall \Gamma, e, t, t', \varpi.\ \pvdash \Gamma e t \varpi:t' \text{ has a positive derivation } \Rightarrow \env {\Gamma,e,t} (\varpi) \leq t'\\
      &\forall \Gamma, \Gamma', e, t.\ \Gamma \evdash e t \Gamma' \text{ has a positive derivation } \Rightarrow \Refine {e,t} \Gamma \leqA \Gamma' \text{ (for $n_o$ large enough)}
    \end{align*}
  \end{theorem}

  Proof:

  We proceed by induction on the derivation.

  Let's prove the first property. We have a positive derivation of $\Gamma \vdash e:t$.

  If $\Gamma = \bot$, we can conclude directly using \Rule{Efq\Aa}. Thus, let's suppose $\Gamma \neq \bot$.

  If $e=x$ is a variable, then the derivation only uses \Rule{Env}, \Rule{Inter} and \Rule{Subs}.
  We can easily conclude just be using \Rule{Var\Aa}. Thus, let's suppose $e$ is not a variable.

  If $e\in\dom\Gamma$, we can have the rule \Rule{Env} in our derivation, but there can only be
  \Rule{Inter} and \Rule{Subs} after it (not \Rule{Abs-} as we have a positive derivation).
  Thus, we can build a positive derivation of $\Gamma \vdash e:t'$ that does not use the rule \Rule{Env} on $e$
  and such that $t'\land \Gamma(e) \leq t$. Thus we have a positive derivation for $\Gamma\setminus\{e\} \vdash e:t'$.
  By using the induction hypothesis we deduce that $\tsrep{\tyof e {\Gamma\setminus\{e\}}} \leq t'$.
  Thus, by looking at the rule \Rule{Env\Aa},
  we deduce $\tsrep{\tyof e \Gamma} \leq \Gamma(e) \land \tsrep{\tyof e {\Gamma\setminus\{e\}}} \leq t$.
  It concludes this case, so let's assume $e\not\in\dom\Gamma$.

  Now we analyze the last rule of the derivation:

  \begin{description}
    \item[\Rule{Env}] Impossible case ($e\not\in\dom\Gamma$).
    \item[\Rule{Inter}] By using the induction hypothesis we get $\tsrep{\tyof e \Gamma} \leq t_1$ and $\tsrep{\tyof e \Gamma} \leq t_2$.
    Thus, we have $\tsrep{\tyof e \Gamma} \leq t_1 \land t_2$. 
    \item[\Rule{Subs}] Trivial using the induction hypothesis.
    \item[\Rule{Const}] We know that the derivation of $\tyof e \Gamma$ ends with the rule \Rule{Const\Aa}.
    Thus this case is trivial.
    \item[\Rule{App}] We know that the derivation of $\tyof e \Gamma$ ends with the rule \Rule{App\Aa}.
    Let $\ts_1 = \tyof {e_1} \Gamma$ and $\ts_2 = \tyof {e_2} \Gamma$. 
    With the induction hypothesis we have $\tsrep {\ts_1} \leq \arrow {t_1} {t_2}$ and $\tsrep {\ts_2} \leq t_1$, with $t_2=t$.
    According to the descriptive definition of $\apply{}{}$, we have
    $\apply{\tsrep {\ts_1}}{\tsrep {\ts_2}} \leq \apply{\arrow {t_1}{t_2}}{t_1} \leq t_2$.
    As we also have $\tsrep{\apply {\ts_1} {\ts_2}} \leq \apply{\tsrep {\ts_1}}{\tsrep {\ts_2}}$,
    we can conclude that $\tyof e \Gamma \leq t_2=t$.

    \item[\Rule{Abs+}] We know that the derivation of $\tyof e \Gamma$ ends with the rule \Rule{Abs\Aa}.
    This case is straightforward using the induction hypothesis.
    \item[\Rule{Abs-}] This case is impossible (the derivation is positive).
    \item[\Rule{Case}] We know that the derivation of $\tyof e \Gamma$ ends with the rule \Rule{Case\Aa}.
    By using the induction hypothesis and the monotonicity lemma, we get $\tsrep{\ts_1}\leq t$ and $\tsrep{\ts_2}\leq t$.
    So we have $\tsrep{\ts_1\tsor\ts_2}=\tsrep{\ts1}\vee\tsrep{\ts2}\leq t$.
    \item[\Rule{Proj}] Quite similar to the case \Rule{App}.
    \item[\Rule{Pair}] We know that the derivation of $\tyof e \Gamma$ ends with the rule \Rule{Pair\Aa}.
    We just use the induction hypothesis and the fact that $\tsrep{\ts_1\tstimes\ts_2}=\pair {\tsrep{\ts1}} {\tsrep{\ts2}}$.
  \end{description}

  \ 

  Now, let's prove the second property. We have a positive derivation of $\pvdash \Gamma e t \varpi:t'$.

  We perform a nested induction on $\varpi$.

  \begin{description}
    \item[\Rule{PSubs}] Trivial using the induction hypothesis.
    \item[\Rule{PInter}] By using the induction hypothesis we get
    $\env {\Gamma,e,t} (\varpi) \leq t_1$ and $\env {\Gamma,e,t} (\varpi) \leq t_2$.
    Thus, we have $\env {\Gamma,e,t} (\varpi) \leq t_1 \land t_2$.
    \item[\Rule{PTypeof}] By using the induction hypothesis we get
    $\tsrep{\tyof {\occ e \varpi} \Gamma} \leq t'$.
    Moreover we have $\env {\Gamma,e,t} (\varpi) \leq \tsrep{\tyof {\occ e \varpi} \Gamma}$
    (by definition), thus we can conclude directly.
    \item[\Rule{PEps}] Trivial.
    \item[\Rule{PAppR}] TODO: not true for this case because of the non-recursive call in the algorithmic system.
    \item[\Rule{PAppL}] TODO
  \end{description}

  TODO

  \qed

  \begin{theorem}[Completeness of the algorithm for acceptable derivations]
    For any $\Gamma$, $e$, $t$ such that we have an acceptable derivation of $\Gamma \vdash e:t$, there exists a global parameter $n_o$
    with which $\tyof e \Gamma \leq t$.

    More precisely:
    \begin{align*}
      &\forall \Gamma, e, t.\ \Gamma \vdash e:t \text{ has an acceptable derivation } \Rightarrow \tyof e \Gamma \leq t\\
      &\forall \Gamma, e, t, t', \varpi.\ \pvdash \Gamma e t \varpi:t' \text{ has an acceptable derivation } \Rightarrow \env {\Gamma,e,t} (\varpi) \tsand \tyof {\occ e \varpi} \Gamma \leq t'\\
      &\forall \Gamma, \Gamma', e, t.\ \Gamma \evdash e t \Gamma' \text{ has an acceptable derivation } \Rightarrow \Refine {e,t} \Gamma \leqA \Gamma' \text{ (for $n_o$ large enough)}
    \end{align*}
  \end{theorem}

\end{document}